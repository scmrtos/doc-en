<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Processes - scmRTOS</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Processes";
        var mkdocs_page_input_path = "src/processes.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> scmRTOS
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Intro</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Instead of a preface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RTOS Components</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../kernel/">Kernel</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Processes</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-information-and-representation">General Information and Representation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#the-process-internals">The Process Internals</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tbaseprocess">TBaseProcess</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stack">Stack</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#timeouts">Timeouts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#priorities">Priorities</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-sleep-function">The sleep() Function</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#process-creation-and-usage">Process Creation and Usage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#defining-a-process-type">Defining a Process Type</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#declaring-a-process-object-and-its-usage">Declaring a Process Object and Its Usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#starting-a-process-in-an-inactive-state">Starting a Process in an Inactive State</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#process-restart">Process Restart</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ipcs/">Interprocess Communications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ports/">Ports</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiler/">Process Performance Profiling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">scmRTOS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">RTOS Components</li>
      <li class="breadcrumb-item active">Processes</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="processes">Processes<a class="headerlink" href="#processes" title="Permanent link">ðŸ”—</a></h1>
<hr />
<h2 id="general-information-and-representation">General Information and Representation<a class="headerlink" href="#general-information-and-representation" title="Permanent link">ðŸ”—</a></h2>
<h3 id="the-process-internals">The Process Internals<a class="headerlink" href="#the-process-internals" title="Permanent link">ðŸ”—</a></h3>
<p>A process in <strong>scmRTOS</strong> is an object of a type derived from the <code>OS::TBaseProcess</code> class. The reason why each process requires a separate type (instead of simply making all processes objects of type <code>OS::TBaseProcess</code>) is that processes, despite all similarities, still differ&nbsp;â€“they have different stack sizes and different priority values (which, it should be remembered, are set statically).</p>
<p>Standard C++ templates are used to define process types. This allows for the creation of "compact" process types containing all the necessary internals, including the process stack itself, whose size is different for each process and is specified individually.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TBaseProcess</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="mo">03</span><span class="w">       </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TKernel</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="mo">04</span><span class="w">       </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TISRW</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="mo">05</span><span class="w">       </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TISRW_SS</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="mo">06</span><span class="w">       </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TKernelAgent</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="mo">07</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="mi">08</span><span class="w">       </span><span class="k">friend</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">run</span><span class="p">();</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="mi">09</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="mi">10</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="mi">11</span><span class="w">        </span><span class="n">TBaseProcess</span><span class="p">(</span><span class="w"> </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">StackPoolEnd</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="mi">12</span><span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="n">TPriority</span><span class="w"> </span><span class="n">pr</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="mi">13</span><span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exec</span><span class="p">)()</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="mi">14</span><span class="w">                </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_DEBUG_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="mi">15</span><span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">StackPool</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="mi">16</span><span class="w">                </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="mi">17</span><span class="w">                    </span><span class="p">);</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="mi">18</span><span class="w">    </span><span class="k">protected</span><span class="o">:</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="mi">19</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">set_unready</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Kernel</span><span class="p">.</span><span class="n">set_process_unready</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">Priority</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="mi">20</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">init_stack_frame</span><span class="p">(</span><span class="w"> </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">StackPoolEnd</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="mi">21</span><span class="w">                             </span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">exec</span><span class="p">)()</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="mi">22</span><span class="w">                         </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_DEBUG_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="mi">23</span><span class="w">                             </span><span class="p">,</span><span class="w"> </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">StackPool</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="mi">24</span><span class="w">                         </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="mi">25</span><span class="w">                             </span><span class="p">);</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="mi">26</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="mi">27</span><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="mi">28</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">wake_up</span><span class="p">();</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="mi">29</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">force_wake_up</span><span class="p">();</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="mi">30</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">force_wake_up</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="mi">31</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_sleeping</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="mi">32</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_suspended</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="mi">33</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="mi">34</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_DEBUG_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="mi">35</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TService</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">waiting_for</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">WaitingFor</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="mi">36</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="mi">37</span><span class="w">               </span><span class="kt">size_t</span><span class="w">     </span><span class="n">stack_slack</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="mi">38</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span><span class="w"> </span><span class="c1">// scmRTOS_DEBUG_ENABLE</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="mi">39</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="mi">40</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_PROCESS_RESTART_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="mi">41</span><span class="w">    </span><span class="k">protected</span><span class="o">:</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="mi">42</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">reset_controls</span><span class="p">();</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="mi">43</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="mi">44</span><span class="w">        </span><span class="c1">//-----------------------------------------------------</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="mi">45</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="mi">46</span><span class="w">        </span><span class="c1">//    Data members</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="mi">47</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="mi">48</span><span class="w">    </span><span class="k">protected</span><span class="o">:</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="mi">49</span><span class="w">        </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w">     </span><span class="n">StackPointer</span><span class="p">;</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="mi">50</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">Timeout</span><span class="p">;</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="mi">51</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">TPriority</span><span class="w">    </span><span class="n">Priority</span><span class="p">;</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="mi">52</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_DEBUG_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="mi">53</span><span class="w">        </span><span class="n">TService</span><span class="w">           </span><span class="o">*</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="n">WaitingFor</span><span class="p">;</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="mi">54</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">stack_item_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">StackPool</span><span class="p">;</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="mi">55</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span><span class="w"> </span><span class="c1">// scmRTOS_DEBUG_ENABLE</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="mi">56</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="mi">57</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_PROCESS_RESTART_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="mi">58</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">WaitingProcessMap</span><span class="p">;</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="mi">59</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="mi">60</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="mi">61</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_SUSPENDED_PROCESS_ENABLE</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="mi">62</span><span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">SuspendedProcessMap</span><span class="p">;</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="mi">63</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="mi">64</span><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 1. TBaseProcess</p>
</figcaption>
</figure>
<h3 id="tbaseprocess">TBaseProcess<a class="headerlink" href="#tbaseprocess" title="Permanent link">ðŸ”—</a></h3>
<p>The core functionality of a process is defined in the base class <code>OS::TBaseProcess</code>. As mentioned above, the actual processes are derived from it using the <code>OS::process&lt;&gt;</code> template. This method is used to avoid duplicating identical code in template instances<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> during their implementation.</p>
<p>Therefore, the template itself declares only what pertains to entities that differ between processesâ€”stacks and the process execution function (<code>exec()</code>). The source code of the <code>OS::TBaseProcess</code> class is presented<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>â€”see "Listing 1. TBaseProcess".</p>
<p>Despite the seemingly extensive definition of this class, it is actually very small and simple. Its representation contains only three data membersâ€”the stack pointer (49), the timeout tick counter (50), and the priority value (51). The remaining data members are auxiliary and are present only when additional functionality is enabledâ€”the ability to interrupt a process at any moment with subsequent restart, as well as debugging facilities<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>.</p>
<p>The class interface provides the following functions:</p>
<ul>
<li><code>sleep(timeout_t timeout = 0)</code>. Transitions the process to a "sleep" state: the argument value is assigned to the internal timeout counter variable, the process is removed from the map of ready processes, and the scheduler is called, which will transfer control to the next ready process.</li>
<li><code>wake_up()</code>. Wakes the process from the "sleep" state. The process is transitioned to the ready state only if it was in a timeout-based waiting state for an event; if this process has a priority higher than the current one, it immediately gains control.</li>
<li><code>force_wake_up()</code>. Wakes the process from the "sleep" state. The process is always transitioned to the ready state. If this process has a priority higher than the current one, it immediately gains control. This function must be used with extreme caution, as incorrect use can lead to improper (unpredictable) program behavior.</li>
<li><code>is_sleeping()</code>. Checks if the process is in a "sleep" state, i.e., in a timeout-based waiting state for an event.</li>
<li><code>is_suspended()</code>. Checks if the process is in an inactive state.</li>
</ul>
<h3 id="stack">Stack<a class="headerlink" href="#stack" title="Permanent link">ðŸ”—</a></h3>
<p>A process stack is a contiguous area of RAM used for storing the process data, as well as for saving the process context and return addresses from functions and interrupts.</p>
<p>Due to the specifics of some architectures, two separate stacks may be used â€” one for data, another for return addresses. <strong>scmRTOS</strong> supports this capability, allowing for the placement of two RAM areas â€” two stacks â€” within each process object. The size of each can be specified individually based on the requirements of the application. Support for two stacks is enabled using the <code>SEPARATE_RETURN_STACK</code> macro defined in the <code>os_target.h</code> file.</p>
<p>Inside the protected section, the very important function <code>init_stack_frame()</code> is declared. It is responsible for forming the stack frame. The fact is that the startup of process executable functions does not occur in the same way as for regular functions â€” process executable functions are not called in the traditional manner. Control is transferred to them in the same way as during context switching between processes. Therefore, starting a process's executable function occurs by restoring that process's context from the stack, followed by a jump to the address stored in the stack at the location of the saved process interrupt return address.</p>
<p>To make such a startup possible, the process stack must be prepared accordingly â€” by initializing memory cells in the stack at specific addresses with the necessary values. In other words, the process stack's contents must be as if the process had been preempted earlier (with its context, of course, saved). The specific actions for preparing the stack frame are individual for each platform, hence the implementation of the <code>init_stack_frame()</code> function is placed at the operating system porting level.</p>
<h3 id="timeouts">Timeouts<a class="headerlink" href="#timeouts" title="Permanent link">ðŸ”—</a></h3>
<p>Each process has a special variable <code>Timeout</code> for controlling the process behavior during event waits with timeouts or during "sleep". Essentially, this variable is a counter for system timer ticks. If its value is not zero, it is decremented and compared to zero within the system timer interrupt handler. Upon reaching zero, the process owning this variable is transitioned to the ready state.</p>
<p>Thus, if a process is in a "sleep" state with a timeout (i.e., placed into the not-ready state by calling the <code>sleep(timeout)</code> function with a non-zero argument), then after an interval equal to the specified number of system timer ticks<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>, the process will be "awoken"<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup> within the system timer interrupt handler.</p>
<p>A similar situation occurs when calling a service function that involves waiting for an event with a timeout. In this case, the process will be transitioned to the ready state either upon the occurrence of the event it is waiting for (which triggered the service function call) or upon timeout expiration. The value returned by the service function unambiguously indicates the source of the process's "awakening", allowing the user program to easily decide on further actions in the given situation.</p>
<h3 id="priorities">Priorities<a class="headerlink" href="#priorities" title="Permanent link">ðŸ”—</a></h3>
<p>Each process also has a data field containing the process priority. This field serves as the process identifier for manipulations with processes and their representations. In particular, the process priority is the index into the table of pointers to processes located within the kernel, where the address of each process is written during registration.</p>
<p>Priorities are unique â€” there cannot be two processes with the same priority. The internal representation of a priority is an integer-type variable. For safety when assigning priorities, a special enumerated type <code>TPriority</code> is used.</p>
<p><a name="process-sleep"></a></p>
<h3 id="the-sleep-function">The sleep() Function<a class="headerlink" href="#the-sleep-function" title="Permanent link">ðŸ”—</a></h3>
<p>This function serves to transition the current process from the active state to the inactive state. If the function is called with an argument equal to 0 (or without specifying an argument â€” the function is declared with a default argument equal to 0), the process will go into "sleep" until it is awakened, for example, by another process using the <code>TBaseProcess::force_wake_up()</code> function. If the function is called with an argument, the process will "sleep" for the specified number of system timer ticks, after which it will be "awoken", i.e., placed into the ready state. In this case, the "sleep" can also be interrupted by another process or an interrupt handler using the <code>TBaseProcess::wake_up()</code> or <code>TBaseProcess::force_wake_up()</code> functions.</p>
<hr />
<h2 id="process-creation-and-usage">Process Creation and Usage<a class="headerlink" href="#process-creation-and-usage" title="Permanent link">ðŸ”—</a></h2>
<h3 id="defining-a-process-type">Defining a Process Type<a class="headerlink" href="#defining-a-process-type" title="Permanent link">ðŸ”—</a></h3>
<p>To create a process, you need to define its type and declare an object of that type.</p>
<p>The type of a specific process is described using the <code>OS::process</code> template: see "Listing 2. Process Template".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="n">TPriority</span><span class="w"> </span><span class="n">pr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">stack_size</span><span class="o">&gt;</span><span class="w">               </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="mo">02</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">process</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TBaseProcess</span><span class="w">                     </span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="mo">03</span><span class="w">    </span><span class="p">{</span><span class="w">                                                       </span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="mo">04</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w">                                                 </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="mo">05</span><span class="w">        </span><span class="n">INLINE_PROCESS_CTOR</span><span class="w"> </span><span class="n">process</span><span class="p">();</span><span class="w">                      </span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="mo">06</span><span class="w">                                                            </span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="mo">07</span><span class="w">        </span><span class="n">OS_PROCESS</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">exec</span><span class="p">();</span><span class="w">                      </span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="mi">08</span><span class="w">                                                            </span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="mi">09</span><span class="w">    </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_PROCESS_RESTART_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w">                 </span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="mi">10</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">terminate</span><span class="p">();</span><span class="w">                            </span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="mi">11</span><span class="w">    </span><span class="err">#</span><span class="n">endif</span><span class="w">                                                  </span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="mi">12</span><span class="w">                                                            </span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="mi">13</span><span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w">                                                </span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="mi">14</span><span class="w">        </span><span class="n">stack_item_t</span><span class="w"> </span><span class="n">Stack</span><span class="p">[</span><span class="n">stack_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stack_item_t</span><span class="p">)];</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="mi">15</span><span class="w">    </span><span class="p">};</span><span class="w">                                                      </span>
</span></code></pre></div>
<figcaption>
<p>Listing 2. Process Template</p>
</figcaption>
</figure>
<p>As you can see, two entities are added to what the base class provides:</p>
<ul>
<li>the process stack <code>Stack</code> with size <code>stack_size</code>. The size is specified in bytes;</li>
<li>the static function <code>exec()</code>, which is the actual function containing the user code of the process.</li>
</ul>
<h3 id="declaring-a-process-object-and-its-usage">Declaring a Process Object and Its Usage<a class="headerlink" href="#declaring-a-process-object-and-its-usage" title="Permanent link">ðŸ”—</a></h3>
<p>Now it's enough to declare an object of this type, which will be the process itself, and to define the process function <code>exec()</code>.</p>
<p><div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">typedef</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">process</span><span class="o">&lt;</span><span class="n">OS</span><span class="o">::</span><span class="n">prn</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Slon</span><span class="p">;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">Slon</span><span class="w"> </span><span class="n">slon</span><span class="p">;</span>
</span></code></pre></div>
where n is the priority number.</p>
<p><a href="../overview/#process-exec">"Listing 1. Process Executable Function"</a> illustrates an example of a typical process function.</p>
<p>Using a process mainly consists of writing user code inside the process function. In doing so, as already mentioned, a few simple rules should be followed:</p>
<ul>
<li>You must ensure that the program's control flow does not leave the process function. Otherwise, due to the fact that this function was not called in the usual way, exiting from it will cause the control flow to go, roughly speaking, to undefined addresses, leading to undefined program behavior (although in practice, the behavior is usually quite definite&nbsp;â€“ the program does not work!);</li>
<li>Use the <code>TBaseProcess::wake_up()</code> function with caution and attention, and <code>TBaseProcess::force_wake_up()</code>&nbsp;â€“ with extra caution, as careless use can lead to untimely "awakening" of a sleeping (suspended) process, which may cause collisions in inter-process communication.</li>
</ul>
<h3 id="starting-a-process-in-an-inactive-state">Starting a Process in an Inactive State<a class="headerlink" href="#starting-a-process-in-an-inactive-state" title="Permanent link">ðŸ”—</a></h3>
<p>Sometimes there is a need for the process executable function to start not immediately after system startup, but upon a specific signal. For example, there are several processes that should start their work only after initializing/configuring some (possibly external to the MCU) equipment; otherwise, unpleasant consequences may arise due to incorrect actions towards that equipment.</p>
<p>In this situation, some dispatching will be required&nbsp;â€“ the processes must somehow organize their work so as not to disrupt the logic of interaction with this equipment&nbsp;â€“ for example, all processes except one (the dispatcher) start by waiting for an event (work start), which will be signaled to them by the dispatcher process.</p>
<p>The dispatcher process performs all necessary preparatory work and then announces the start of work to the waiting processes. The described approach would require adding corresponding code manually in each process waiting for the start, which clutters the code, adds work, and is error-prone.</p>
<p>Furthermore, there may be other situations where it is required that a process does not start its work immediately. To provide the described functionality, a process has the ability to start in a so-called inactive state. Such a process is no different from any other except that its tag is absent in the map of processes ready for execution (<code>ReadyProcessMap</code>).</p>
<p>The declaration of such a process looks like this<sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>:
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">typedef</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">process</span><span class="o">&lt;</span><span class="n">OS</span><span class="o">::</span><span class="n">pr1</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">pssSuspended</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Proc2</span><span class="p">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">...</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">Proc2</span><span class="w"> </span><span class="n">proc2</span><span class="p">;</span>
</span></code></pre></div></p>
<p>Later, to start the work of this process, the launching code must call the <code>force_wake_up()</code> function:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">Proc2</span><span class="p">.</span><span class="n">force_wake_up</span><span class="p">();</span>
</span></code></pre></div>
<hr />
<p><a name="process-restart"></a></p>
<h2 id="process-restart">Process Restart<a class="headerlink" href="#process-restart" title="Permanent link">ðŸ”—</a></h2>
<p>A situation may arise when it is necessary to interrupt a process from the outside and start its execution from the beginning. For example, a process performs lengthy calculations, and it turns out that the results of these calculations are no longer needed at some point, and a new calculation cycle with new data must be started. This can be done by terminating the process with the possibility of subsequently restarting it from the beginning.</p>
<p>To implement the above, the OS provides the user with two functions:</p>
<ul>
<li><code>OS::process::terminate()</code>;</li>
<li><code>OS::TBaseProcess::start()</code>.</li>
</ul>
<p>The <code>terminate()</code> function is intended to be called from outside the process being stopped. Inside it, all resources associated with this process are reset to their initial state, and the process is transitioned to the not-ready state. If the process was waiting for a service, its tag is removed from that service's map of waiting processes.</p>
<p>Process startup is performed separately&nbsp;â€“ so that the user has the opportunity to do it at a moment they deem appropriate&nbsp;â€“ and is carried out using the <code>start()</code> function, which simply transitions the process to the ready state. The process will start working according to the sequence determined by its priority and the OS load.</p>
<p>For the process interruption and restart to work correctly, this functionality must be enabled during configuration&nbsp;â€“ the value of the <code>scmRTOS_PROCESS_RESTART_ENABLE</code> macro must be set to 1.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The term "instance" is often used in jargon.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Actually, there are two variants of this classâ€”the standard one (shown here) and one with a separate stack for return addresses. The latter is not included here for brevity, as it contains no fundamental differences relevant for understanding or exposition.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>The same applies to the rest of the codeâ€”much of the class definition is occupied by the description of these auxiliary capabilities.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Strictly speaking, not exactly equal to the number of system timer ticks, but with an accuracy up to a fraction of this period, which depends on the moment the <code>sleep</code> function is called relative to the moment the system timer interrupt occurs.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>I.e., transitioned to the ready state.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>The ss prefix in this example stands for Start State&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../kernel/" class="btn btn-neutral float-left" title="Kernel"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../ipcs/" class="btn btn-neutral float-right" title="Interprocess Communications">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../kernel/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../ipcs/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/mathjax.js"></script>
      <script src="../../js/mathjax/tex-mml-chtml.js"></script>
      <script src="../../js/wavedrom.min.js"></script>
      <script src="../../js/wavedrom_loader.js"></script>
      <script src="../../js/wavedrom.unpkg.js"></script>
      <script src="../../js/wavedrom_skin_default.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
