<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Interprocess Communications - scmRTOS</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Interprocess Communications";
        var mkdocs_page_input_path = "src/ipcs.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> scmRTOS
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Intro</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Instead of a preface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RTOS Components</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../kernel/">Kernel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../processes/">Processes</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Interprocess Communications</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tservice">TService</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#class-definition">Class Definition</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#preliminary-remarks">Preliminary Remarks</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#requirements-for-the-functions-of-the-class-being-developed">Requirements for the Functions of the Class Being Developed</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#osteventflag">OS::TEventFlag</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#wait">wait</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#signal">signal</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_1">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_1">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#signal-from-isr">signal from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_2">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_2">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#clear">clear</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_3">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_3">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#check-if-signaled">check if signaled</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_4">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_4">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ostmutex">OS::TMutex</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_1">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#lock">lock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_5">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_5">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#unlock">unlock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_6">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_6">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#unlock-from-isr">unlock from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_7">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_7">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#try-to-lock">try to lock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_8">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_8">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#try-to-lock-with-timeout">try to lock with timeout</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_9">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_9">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#check-if-locked">check if locked</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_10">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_10">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_1">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#osmessage">OS::message</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_2">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#send">send</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_11">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_11">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#send-from-isr">send from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_12">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_12">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#wait_1">wait</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_13">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_13">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#check-if-non-empty">check if non-empty</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_14">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_14">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#reset">reset</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_15">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_15">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-message-contents">write message contents</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_16">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_16">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#access-message-body-by-reference">access message body by reference</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_17">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_17">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-message-contents">read message contents</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_18">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_18">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_2">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#oschannel">OS::channel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_3">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#push">push</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_19">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_19">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#push-front">push front</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_20">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_20">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pop">pop</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_21">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_21">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pop-back">pop back</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_22">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_22">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write">write</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_23">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_23">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-inside-isr">write inside ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_24">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_24">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read">read</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_25">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_25">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-inside-isr">read inside ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_26">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_26">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#get-item-count">get item count</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_27">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_27">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#get-free-size">get free size</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_28">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_28">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#flush">flush</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_29">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_29">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_3">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#final-remarks">Final Remarks</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ports/">Ports</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiler/">Process Performance Profiling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">scmRTOS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">RTOS Components</li>
      <li class="breadcrumb-item active">Interprocess Communications</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="interprocess-communication-services">Interprocess Communication Services<a class="headerlink" href="#interprocess-communication-services" title="Permanent link">ðŸ”—</a></h1>
<hr />
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">ðŸ”—</a></h2>
<p>Starting with version 4, <strong>scmRTOS</strong> employs a fundamentally different mechanism for implementing interprocess communication services compared to previous versions. Previously, each service class was developed individually and had no connection to the others, and to access kernel resources, service classes were declared as "friends" of the kernel. This approach did not allow for code reuse<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> and offered no possibility to extend the set of services, which led to the decision to abandon it and design a variant free from both shortcomings.</p>
<p>The implementation is based on the concept of extending OS functionality by defining extension classes through inheritance from <code>TKernelAgent</code> (see <a href="../kernel/#kernel-agent">"TKernelAgent and Extensions"</a>).</p>
<p>The key class for building interprocess communication services is the <code>TService</code> class, which implements the common functionality for all service classes. All of them are descendants of <code>TService</code>. This applies both to the standard set of services included in the OS distribution and to those developed<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> as extensions to the standard range of services.</p>
<p>The interprocess communication services included in scmRTOS are:</p>
<ul>
<li><code>OS::TEventFlag</code>;</li>
<li><code>OS::TMutex</code>;</li>
<li><code>OS::message</code>;</li>
<li><code>OS::channel</code>;</li>
</ul>
<hr />
<h2 id="tservice">TService<a class="headerlink" href="#tservice" title="Permanent link">ðŸ”—</a></h2>
<h3 id="class-definition">Class Definition<a class="headerlink" href="#class-definition" title="Permanent link">ðŸ”—</a></h3>
<p>The code for the base class used to build service types:</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TService</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="n">TKernelAgent</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="mo">03</span><span class="w">    </span><span class="k">protected</span><span class="o">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="mo">04</span><span class="w">        </span><span class="n">TService</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TKernelAgent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="mo">05</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="mo">06</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w">  </span><span class="n">cur_proc_prio_tag</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">get_prio_tag</span><span class="p">(</span><span class="n">cur_proc_priority</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="mo">07</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w">  </span><span class="n">highest_prio_tag</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">map</span><span class="p">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="mi">08</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="mi">09</span><span class="w">        </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_PRIORITY_ORDER</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="mi">10</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">   </span><span class="c1">// Isolate rightmost 1-bit.</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="mi">11</span><span class="w">        </span><span class="err">#</span><span class="k">else</span><span class="w">   </span><span class="c1">// scmRTOS_PRIORITY_ORDER == 1</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="mi">12</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">get_prio_tag</span><span class="p">(</span><span class="n">highest_priority</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="mi">13</span><span class="w">        </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="mi">14</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="mi">15</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="mi">16</span><span class="w">        </span><span class="c1">//----------------------------------------------------------------------</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="mi">17</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="mi">18</span><span class="w">        </span><span class="c1">//   Base API</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="mi">19</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="mi">20</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="mi">21</span><span class="w">        </span><span class="c1">// add prio_tag proc to waiters map, reschedule</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="mi">22</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">suspend</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="mi">23</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="mi">24</span><span class="w">        </span><span class="c1">// returns false if waked-up by timeout or TBaseProcess::wake_up() | force_wake_up()</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="mi">25</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_timeouted</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="mi">26</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="mi">27</span><span class="w">        </span><span class="c1">// wake-up all processes from waiters map</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="mi">28</span><span class="w">        </span><span class="c1">// return false if no one process was waked-up</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="mi">29</span><span class="w">               </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_all</span><span class="w">     </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="mi">30</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_all_isr</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="mi">31</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="mi">32</span><span class="w">        </span><span class="c1">// wake-up next ready (most priority) process from waiters map if any</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="mi">33</span><span class="w">        </span><span class="c1">// return false if no one process was waked-up</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="mi">34</span><span class="w">               </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_next_ready</span><span class="w">     </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="mi">35</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_next_ready_isr</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="mi">36</span><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 1. TService</p>
</figcaption>
</figure>
<p>Similar to its ancestor class <code>TKernelAgent</code>, the <code>TService</code> class does not allow objects of its own type to be created: its purpose is to provide a base for building specific typesâ€”interprocess communication services. The interface of this class consists of a set of functions that express the common actions of any service class within the context of control transfer between processes. Logically, these functions can be divided into two parts: core functions and utility functions.</p>
<p>The utility functions are:</p>
<ol>
<li><code>TService::cur_proc_prio_tag()</code>. Returns the tag<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> corresponding to the currently active process. This tag is actively used by the core service functions to record the identifiers<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup> of processes when placing the current process into a waiting state.</li>
<li><code>TService::highest_prio_tag()</code>. Returns the tag of the highest-priority process from the process map passed as an argument. It is used primarily to obtain the identifier (of the process) from the process map of a service object, corresponding to the process that should be transitioned to the ready state.</li>
</ol>
<p>The core functions are:</p>
<ol>
<li><code>TService::suspend()</code>. Transfers the process to a not-ready state, records the process identifier in the service's process map, and calls the OS scheduler. This function forms the basis of the service member functions used for waiting for an event (<code>wait()</code>, <code>pop()</code>, <code>read()</code>) or actions that might cause waiting for a resource to be released (<code>lock()</code>, <code>push()</code>, <code>write()</code>).</li>
<li><code>TService::is_timeouted()</code>. This function returns <code>false</code> if the process was transitioned to the ready state by calling a service member function; however, if the process was transitioned to the ready state due to a timeout<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup> or forcibly using the <code>TBaseProcess</code> member functions <code>wake_up()</code> and <code>force_wake_up()</code>, then the function returns <code>true</code>. The result of this function is used to determine whether the process received the event (resource release) it was waiting for or not.</li>
<li><code>TService::resume_all()</code>. This function checks for the presence of processes "recorded" in the service's process map but currently in a not-ready state<sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>; if such processes exist, all of them are transitioned to the ready state and the scheduler is called. In this case, the function returns <code>true</code>; otherwise, it returns <code>false</code>.</li>
<li><code>TService::resume_next_ready()</code>. This function performs actions similar to the <code>resume_all()</code> function described above, with the difference that if there are waiting processes, not all of them are transitioned to the ready state, but only oneâ€”the highest-priority one.</li>
</ol>
<p>For the <code>resume_all()</code> and <code>resume_next_ready()</code> functions, there are versions optimized for use inside interrupt handlersâ€”these are <code>resume_all_isr()</code> and <code>resume_next_ready_isr()</code>. In purpose and meaning, they are similar to the main variants<sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>; the key difference is that they do not call the scheduler.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">ðŸ”—</a></h3>
<h4 id="preliminary-remarks">Preliminary Remarks<a class="headerlink" href="#preliminary-remarks" title="Permanent link">ðŸ”—</a></h4>
<p>Any service class is created from <code>TService</code> through inheritance. To illustrate the usage of <code>TService</code> and the creation of a service class based on it, we will examine one of the standard interprocess communication servicesâ€”<code>TEventFlag</code>:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TEventFlag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>The service class <code>TEventFlag</code> itself will be described in detail later. For the continuity of the narrative at this point, it should be noted that this interprocess communication service is used to synchronize the work of processes in accordance with occurring events. The main idea of its usage is: one process waits for an event using the class member function <code>TEventFlag::wait()</code>, while another process<sup id="fnref:8"><a class="footnote-ref" href="#fn:8">8</a></sup>, upon the occurrence of an event that should be handled by the waiting process, signals the flag using the member function <code>TEventFlag::signal()</code>.</p>
<p>Given the above, the main focus when examining the usage example will be on these two functions, as they carry the primary semantic load of the service class<sup id="fnref:9"><a class="footnote-ref" href="#fn:9">9</a></sup>, and its development essentially boils down to the development of such functions.</p>
<h4 id="requirements-for-the-functions-of-the-class-being-developed">Requirements for the Functions of the Class Being Developed<a class="headerlink" href="#requirements-for-the-functions-of-the-class-being-developed" title="Permanent link">ðŸ”—</a></h4>
<p>Requirements for the event flag waiting function. The function must check whether the event has occurred at the moment of the function call. If the event has not occurred, it must be able to wait<sup id="fnref:10"><a class="footnote-ref" href="#fn:10">10</a></sup> for the event either unconditionally or with a timeout condition. If the function returns due to the event, the return value should be <code>true</code>; if it returns due to a timeout, the return value should be <code>false</code>.</p>
<p>Requirements for the event flag signaling function. The function must transition all processes waiting for the event flag to the ready state and transfer control to the scheduler.</p>
<h4 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">ðŸ”—</a></h4>
<p>Inside the member function <code>wait()</code> (see "Listing 2. Function TEventFlag::wait()"), the first step is to check if the event has already been signaled. If it has, the function returns <code>true</code>. If the event has not been signaled (i.e., it needs to be waited for), preparatory actions are performedâ€”in particular, the waiting timeout value is written to the <code>Timeout</code> variable of the current process, and the <code>suspend()</code> function, defined in the base class <code>TService</code>, is called. This function writes the tag of the current process into the process map of the event flag object (passed to <code>suspend()</code> as an argument), transitions this process to a not-ready state, and yields control to other processes by calling the scheduler.</p>
<p>Upon returning from <code>suspend()</code>, which means this process has been transitioned back to the ready state, a check is performed to determine what caused the "wake-up" of this process. This is done by calling the <code>is_timeouted()</code> function. It returns <code>false</code> if the process was "awakened" via a call to <code>TEventFlag::signal()</code>â€”i.e., the awaited event occurred (and no timeout happened). It returns <code>true</code> if the process "wake-up" occurred due to the expiration of the timeout specified in the <code>TEventFlag::wait()</code> argument, or if it was forced.</p>
<p>This logic of the <code>TEventFlag::wait()</code> member function allows it to be effectively used in user code when organizing process work synchronized with the occurrence of required events<sup id="fnref:11"><a class="footnote-ref" href="#fn:11">11</a></sup>. Moreover, the implementation code of this function is simple and transparent.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="mo">01</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="mo">03</span><span class="w">        </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="mo">04</span><span class="w">   </span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="mo">05</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="w">                         </span><span class="c1">// if flag already signaled</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="mo">06</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="mo">07</span><span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">;</span><span class="w">                </span><span class="c1">// clear flag</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="mi">08</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="mi">09</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="mi">10</span><span class="w">        </span><span class="k">else</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="mi">11</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="mi">12</span><span class="w">            </span><span class="n">cur_proc_timeout</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="mi">13</span><span class="w">   </span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="mi">14</span><span class="w">            </span><span class="n">suspend</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">);</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="mi">15</span><span class="w">   </span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="mi">16</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">is_timeouted</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">))</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="mi">17</span><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">            </span><span class="c1">// waked up by timeout or by externals</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="mi">18</span><span class="w">   </span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="mi">19</span><span class="w">            </span><span class="n">cur_proc_timeout</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="mi">20</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                 </span><span class="c1">// otherwise waked up by signal() or signal_isr()</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="mi">21</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="mi">22</span><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 2. Function TEventFlag::wait()</p>
</figcaption>
</figure>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="mi">1</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal</span><span class="p">()</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="mi">2</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="mi">3</span><span class="w">        </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="mi">4</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">resume_all</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">))</span><span class="w">   </span><span class="c1">// if no one process was waiting for flag</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="mi">5</span><span class="w">            </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOn</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="mi">6</span><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 3. Function TEventFlag::signal()</p>
</figcaption>
</figure>
<p>The code for the <code>TEventFlag::signal()</code> function (see "Listing 3. Function TEventFlag::signal()") is extremely simple: inside it, all processes waiting for this event flag are transitioned to the ready state, and rescheduling is performed. If no such processes were found, the internal flag variable <code>Value</code> is set to <code>efOn</code> (true), which means the event occurred but hasn't been handled by anyone yet.</p>
<p>Any interprocess communication service can be designed and defined in a similar manner. During its development, it is only necessary to have a clear understanding of what the member functions of the <code>TService</code> class do and to use them appropriately.</p>
<hr />
<h2 id="osteventflag">OS::TEventFlag<a class="headerlink" href="#osteventflag" title="Permanent link">ðŸ”—</a></h2>
<p>During program execution, there is often a need for synchronization between processes. For example, one of the processes may need to wait for an event to perform its work. It can handle this in different ways: it can simply poll a global flag in a loop or do the same with some periodicityâ€”i.e., poll, "go to sleep" with a timeout, "wake up," poll again, etc. The first method is bad because all processes with lower priority will not gain control, as due to their lower priorities, they cannot preempt the process polling the global flag in a loop.</p>
<p>The second method is also badâ€”the polling period becomes quite large (i.e., time resolution is low), and during polling, the process will occupy the CPU with context switches, even though it is unknown whether the event has occurred.</p>
<p>A proper solution in this situation is to transition the process to a state of waiting for the event and transfer control to the process only when the event occurs.</p>
<p>This functionality in scmRTOS is implemented using <code>OS::TEventFlag</code> objects (event flag). The class definition is shown in "Listing 4. OS::TEventFlag".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TEventFlag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span><span class="w">                                            </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span><span class="w">                                                                             </span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="mo">03</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w">                                                                       </span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="mo">04</span><span class="w">        </span><span class="k">enum</span><span class="w"> </span><span class="nc">TValue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">efOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">efOff</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// prefix &#39;ef&#39; means: &quot;Event Flag&quot;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="mo">05</span><span class="w">                                                                                  </span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="mo">06</span><span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w">                                                                       </span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="mo">07</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TEventFlag</span><span class="p">(</span><span class="n">TValue</span><span class="w"> </span><span class="n">init_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">);</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="mi">08</span><span class="w">                                                                                  </span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="mi">09</span><span class="w">               </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">                                  </span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="mi">10</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">signal</span><span class="p">();</span><span class="w">                                                     </span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="mi">11</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">clear</span><span class="p">()</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">                </span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="mi">12</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">signal_isr</span><span class="p">();</span><span class="w">                                                 </span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="mi">13</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_signaled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">efOn</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">         </span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="mi">14</span><span class="w">                                                                                  </span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="mi">15</span><span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w">                                                                      </span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="mi">16</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span><span class="w">                                          </span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="mi">17</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TValue</span><span class="w">      </span><span class="n">Value</span><span class="p">;</span><span class="w">                                               </span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="mi">18</span><span class="w">    </span><span class="p">};</span><span class="w">                                                                            </span>
</span></code></pre></div>
<figcaption>
<p>Listing 4. OS::TEventFlag</p>
</figcaption>
</figure>
<h3 id="interface">Interface<a class="headerlink" href="#interface" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="wait"><u>wait</u><a class="headerlink" href="#wait" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype">Prototype<a class="headerlink" href="#prototype" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">OS::TEventFlag::wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description">Description<a class="headerlink" href="#description" title="Permanent link">ðŸ”—</a></h6>
<p>Waits for an event. When the <code>wait()</code> function is called, the following occurs: it checks if the flag is set. If it is set, the flag is cleared and the function returns <code>true</code>, meaning the event had already occurred at the time of the check. If the flag is not set (i.e., the event has not yet occurred), the process is transitioned to a state of waiting for this flag (event) and control is yielded to the kernel, which, after rescheduling processes, will run the next one.</p>
<p>If the function is called without arguments (or with an argument equal to 0), the process will remain in the waiting state until the event flag is "signaled" by another process or an interrupt handler (using the <code>signal()</code> function) or is brought out of the inactive state using the <code>TBaseProcess::force_wake_up()</code> function (in the latter case, extreme caution is required).</p>
<p>If <code>wait()</code> is called without an argument, it always returns <code>true</code>. If the function is called with an argument (an integer greater than 0) specifying the waiting timeout in system timer ticks, the process will wait for the event as in the case of a call without an argument. However, if the event flag is not "signaled" within the specified period, the process will be "awakened" by the timer and the function will return <code>false</code>. This implements both unconditional waiting and waiting with a timeout.</p>
<hr />
<h4 id="signal"><u>signal</u><a class="headerlink" href="#signal" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_1">Prototype<a class="headerlink" href="#prototype_1" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_1">Description<a class="headerlink" href="#description_1" title="Permanent link">ðŸ”—</a></h6>
<p>A process that wishes to notify other processes via a <code>TEventFlag</code> object that a particular event has occurred must call the <code>signal()</code> function. As a result, all processes waiting for the specified event will be transitioned to the ready state, and the highest-priority among them will gain control (the others will follow in order of their priorities).</p>
<hr />
<h4 id="signal-from-isr"><u>signal from ISR</u><a class="headerlink" href="#signal-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_2">Prototype<a class="headerlink" href="#prototype_2" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_2">Description<a class="headerlink" href="#description_2" title="Permanent link">ðŸ”—</a></h6>
<p>A variant of the above function optimized for use in interrupts. The function is inline and uses a special lightweight inline version of the scheduler. This variant must not be used outside of interrupt handler code.</p>
<hr />
<h4 id="clear"><u>clear</u><a class="headerlink" href="#clear" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_3">Prototype<a class="headerlink" href="#prototype_3" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">clear</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_3">Description<a class="headerlink" href="#description_3" title="Permanent link">ðŸ”—</a></h6>
<p>Clears the flag. Sometimes, for synchronization, it is necessary to wait for the <em>next</em> event, not to handle an already occurred one. In this case, the event flag must be cleared before proceeding to wait. The <code>clear()</code> function is used for this purpose.</p>
<hr />
<h4 id="check-if-signaled"><u>check if signaled</u><a class="headerlink" href="#check-if-signaled" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_4">Prototype<a class="headerlink" href="#prototype_4" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">is_signaled</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_4">Description<a class="headerlink" href="#description_4" title="Permanent link">ðŸ”—</a></h6>
<p>Checks the state of the flag. It is not always necessary to wait for an event by yielding control. Sometimes, based on the program's logic, it is only necessary to check whether the event has occurred.</p>
<hr />
<h3 id="usage-example">Usage Example<a class="headerlink" href="#usage-example" title="Permanent link">ðŸ”—</a></h3>
<p>An example of using an event flag is shown in "Listing 5. Using TEventFlag".</p>
<p>In this example, process <code>Proc1</code> waits for an event with a timeout of 10 system timer ticks (9). The second process, <code>Proc2</code>, "signals" the flag when a condition is met (27). If the first process has higher priority, it will gain control immediately.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="mo">01</span><span class="w">    </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="w"> </span><span class="n">eflag</span><span class="p">;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="mo">03</span><span class="w">    </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="mo">04</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="mo">05</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="mo">06</span><span class="w">        </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="mo">07</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="mi">08</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="mi">09</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eflag</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">// wait event for 10 ticks</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="mi">10</span><span class="w">            </span><span class="p">{</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="mi">11</span><span class="w">                </span><span class="p">...</span><span class="w">   </span><span class="c1">// do something</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="mi">12</span><span class="w">            </span><span class="p">}</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="mi">13</span><span class="w">            </span><span class="k">else</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="mi">14</span><span class="w">            </span><span class="p">{</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="mi">15</span><span class="w">                </span><span class="p">...</span><span class="w">   </span><span class="c1">// do something else</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="mi">16</span><span class="w">            </span><span class="p">}</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="mi">17</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="mi">18</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="mi">19</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="mi">20</span><span class="w">    </span><span class="p">...</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="mi">21</span><span class="w">    </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="mi">22</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="mi">23</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="mi">24</span><span class="w">        </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="mi">25</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="mi">26</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="mi">27</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">eflag</span><span class="p">.</span><span class="n">signal</span><span class="p">();</span><span class="w"> </span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="mi">28</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="mi">29</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="mi">30</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="mi">31</span><span class="w">    </span><span class="c1">//----------------------------------------------------------------</span>
</span></code></pre></div>
<figcaption>
<p>Listing 5. Using TEventFlag</p>
</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title"><strong>NOTE</strong></p>
<p>When an event occurs and a process "signals" the flag, <strong>all</strong> processes that were waiting for this flag will be transitioned to the ready state. In other words, everyone who was waiting has now received the event. They will, of course, gain control in the order of their priorities, but the event will not be missed by any process that managed to start waiting, regardless of its priority.</p>
<p>Thus, an event flag <em>exhibits broadcast behavior</em>, which is very useful for organizing notifications and synchronizing multiple processes based on a single event. Of course, nothing prevents using an event flag in a "point-to-point" scheme where there is only one process waiting for the event.</p>
</div>
<hr />
<h2 id="ostmutex">OS::TMutex<a class="headerlink" href="#ostmutex" title="Permanent link">ðŸ”—</a></h2>
<p>The Mutex semaphore (from Mutual Exclusion), as the name suggests, is designed to organize mutual exclusion of access. That is, at any given moment, no more than one process can hold this semaphore. If any process attempts to lock a Mutex that is already held by another process, the attempting process will wait until the semaphore is released.</p>
<p>The primary use of Mutex semaphores is to organize mutual exclusion when accessing a particular resource. For example, a static array with global visibility<sup id="fnref:12"><a class="footnote-ref" href="#fn:12">12</a></sup> is used by two processes to exchange data. To avoid errors during the exchange, it is necessary to prevent one process from having access to the array during the period when another process is working with it.</p>
<p>Using a critical section for this is not the best approach, as interrupts would be disabled for the entire time the process accesses the array. This time might be significant, and during it, the system would be unable to respond to events. In this situation, a mutual exclusion semaphore is perfectly suitable: a process planning to work with a shared resource must first lock the Mutex semaphore. After that, it can safely work with the resource.</p>
<p>Upon completion of the work, the semaphore must be released so that other processes can access it. It goes without saying that all processes working with the shared resource should behave this way, i.e., access it through the semaphore<sup id="fnref:13"><a class="footnote-ref" href="#fn:13">13</a></sup>.</p>
<p>These same considerations fully apply to calling a non-reentrant<sup id="fnref:14"><a class="footnote-ref" href="#fn:14">14</a></sup> function.</p>
<div class="admonition warning">
<p class="admonition-title"><strong>WARNING</strong></p>
<p>When using mutual exclusion semaphores, a situation may arise where one process, having locked a semaphore and working with the corresponding resource, attempts to access another resource, which is also accessed by locking another semaphore. This second semaphore is already locked by another process, which, in turn, is trying to access the resource already being used by the first process. As a result, both processes are waiting for each other to release the locked resource, and until that happens, neither can continue its work.</p>
<p>This situation is called a "deadlock"<sup id="fnref:15"><a class="footnote-ref" href="#fn:15">15</a></sup>. In English-language literature, it is denoted by the word "Deadlock." To avoid it, the programmer must carefully monitor access to shared resources. A good rule to prevent the situation described above is to lock no more than one mutual exclusion semaphore at a time. In any case, success here is based on the attentiveness and discipline of the program developer.</p>
</div>
<p>For implementing binary semaphores of this type, <strong>scmRTOS</strong> defines the <code>OS::TMutex</code> class. See "Listing 6. OS::TMutex".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TMutex</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="mo">03</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="mo">04</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TMutex</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">ValueTag</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="mo">05</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">lock</span><span class="p">();</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="mo">06</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">unlock</span><span class="p">();</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="mo">07</span><span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="n">unlock_isr</span><span class="p">();</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="mi">08</span><span class="w">   </span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="mi">09</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">try_lock</span><span class="p">()</span><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">ValueTag</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="mi">10</span><span class="w">                                                      </span><span class="k">else</span><span class="w"> </span><span class="n">lock</span><span class="p">();</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="mi">11</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_locked</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ValueTag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="mi">12</span><span class="w">   </span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="mi">13</span><span class="w">    </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="mi">14</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="mi">15</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ValueTag</span><span class="p">;</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="mi">16</span><span class="w">   </span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="mi">17</span><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 6. OS::TMutex</p>
</figcaption>
</figure>
<p>Obviously, before use, the semaphore must be created. Due to the specifics of its application, the semaphore should have the same storage class and scope as the resource it serves, i.e., it should be a static object with global visibility<sup id="fnref:16"><a class="footnote-ref" href="#fn:16">16</a></sup>.</p>
<h3 id="interface_1">Interface<a class="headerlink" href="#interface_1" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="lock"><u>lock</u><a class="headerlink" href="#lock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_5">Prototype<a class="headerlink" href="#prototype_5" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">TMutex::lock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_5">Description<a class="headerlink" href="#description_5" title="Permanent link">ðŸ”—</a></h6>
<p>Performs a blocking lock: if the semaphore was not previously locked by another process, its internal state is set to "locked," and the execution flow returns to the calling function. If the semaphore was already locked, the process will transition to a waiting state until the semaphore is released, and control is yielded to the kernel.</p>
<hr />
<h4 id="unlock"><u>unlock</u><a class="headerlink" href="#unlock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_6">Prototype<a class="headerlink" href="#prototype_6" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">TMutex::unlock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_6">Description<a class="headerlink" href="#description_6" title="Permanent link">ðŸ”—</a></h6>
<p>The function sets the internal state to "unlocked" and checks if any other process is waiting for this semaphore. If there is, control is yielded to the kernel, which will reschedule processes so that if the waiting process had higher priority, it will immediately gain control. If several processes were waiting for the semaphore, the highest-priority one among them will gain control. Only the process that locked the semaphore can unlock itâ€”i.e., if this function is executed in a process that did not lock the mutex object, it will have no effect, and the object will remain in the same state.</p>
<hr />
<h4 id="unlock-from-isr"><u>unlock from ISR</u><a class="headerlink" href="#unlock-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_7">Prototype<a class="headerlink" href="#prototype_7" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">unlock_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_7">Description<a class="headerlink" href="#description_7" title="Permanent link">ðŸ”—</a></h6>
<p>Sometimes a situation arises where a mutex is locked within a process, but work with the corresponding protected resource is performed in an interrupt handler (and this work is initiated in the process simultaneously with locking the mutex).</p>
<p>In this case, it is convenient to perform the unlock directly in the interrupt handler upon completion of work with the resource. For this purpose, <code>TMutex</code> includes the <code>unlock_isr()</code> function for unlocking the semaphore directly within an interrupt.</p>
<hr />
<h4 id="try-to-lock"><u>try to lock</u><a class="headerlink" href="#try-to-lock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_8">Prototype<a class="headerlink" href="#prototype_8" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">try_lock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_8">Description<a class="headerlink" href="#description_8" title="Permanent link">ðŸ”—</a></h6>
<p>Non-blocking lock. The difference from <code>lock()</code> is that the lock will only occur if the semaphore is free. For example, a process needs to work with a resource but also has a lot of other work. Attempting to lock with <code>lock()</code> might cause it to wait until the semaphore is freed, whereas that time could be spent on other work if available, and work with the shared resource could be performed only when access to it is not blocked.</p>
<p>This approach can be relevant for a high-priority process: if the semaphore is locked by a low-priority process, it is reasonable for the high-priority process not to yield control to the low-priority one if it has other work. Only when there is nothing left to do does it make sense to attempt to lock the semaphore in the usual wayâ€”by yielding control (since the low-priority process must also eventually gain control to finish its tasks and release the semaphore).</p>
<p>Considering the above, this function should be used with caution, as it could lead to a situation where a low-priority process never gains control because the high-priority one does not yield it.</p>
<hr />
<h4 id="try-to-lock-with-timeout"><u>try to lock with timeout</u><a class="headerlink" href="#try-to-lock-with-timeout" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_9">Prototype<a class="headerlink" href="#prototype_9" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="o">::</span><span class="n">try_lock</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_9">Description<a class="headerlink" href="#description_9" title="Permanent link">ðŸ”—</a></h6>
<p>A blocking version of the previous function with a specified time intervalâ€”attempts to lock the semaphore within the specified timeout. If the lock is successful, returns <code>true</code>; otherwise, returns <code>false</code>.</p>
<hr />
<h4 id="check-if-locked"><u>check if locked</u><a class="headerlink" href="#check-if-locked" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_10">Prototype<a class="headerlink" href="#prototype_10" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">is_locked</span><span class="p">()</span>
</span></code></pre></div>
<h6 id="description_10">Description<a class="headerlink" href="#description_10" title="Permanent link">ðŸ”—</a></h6>
<p>The function checks the state and returns <code>true</code> if the semaphore is locked, and <code>false</code> otherwise. It is sometimes convenient to use a semaphore as a status flag, where one process sets this flag (by locking the semaphore), and other processes check it and perform actions according to the state of that process.</p>
<hr />
<h3 id="usage-example_1">Usage Example<a class="headerlink" href="#usage-example_1" title="Permanent link">ðŸ”—</a></h3>
<p>See "Listing 7. Example of Using OS::TMutex" for a usage example.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="mo">01</span><span class="w">    </span><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="w"> </span><span class="n">Mutex</span><span class="p">;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="mo">02</span><span class="w">    </span><span class="n">byte</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="mo">03</span><span class="w">    </span><span class="p">...</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="mo">04</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">TSlon</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="mo">05</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="mo">06</span><span class="w">        </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="mo">07</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="mi">08</span><span class="w">            </span><span class="p">...</span><span class="w">                           </span><span class="c1">// some code</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="mi">09</span><span class="w">                                          </span><span class="c1">//</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="mi">10</span><span class="w">            </span><span class="n">Mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w">                 </span><span class="c1">// resource access lock</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="mi">11</span><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="c1">//   </span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="mi">12</span><span class="w">            </span><span class="p">{</span><span class="w">                             </span><span class="c1">//</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="mi">13</span><span class="w">                </span><span class="p">...</span><span class="w">                       </span><span class="c1">// do something with buf</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="mi">14</span><span class="w">            </span><span class="p">}</span><span class="w">                             </span><span class="c1">//</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="mi">15</span><span class="w">            </span><span class="n">Mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w">               </span><span class="c1">// resource access unlock</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="mi">16</span><span class="w">                                          </span><span class="c1">//</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="mi">17</span><span class="w">            </span><span class="p">...</span><span class="w">                           </span><span class="c1">// some code</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="mi">18</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="mi">19</span><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 7. Example of Using OS::TMutex</p>
</figcaption>
</figure>
<p>For convenience when using a mutual exclusion semaphore, the already mentioned wrapper class technique can be applied. In this case, it is implemented using the <code>TMutexLocker</code> class, included in the OS distribution. See "Listing 8. Wrapper Class OS::TMutexLocker".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="mo">01</span><span class="w">     </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Mutex</span><span class="o">&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="mo">02</span><span class="w">     </span><span class="k">class</span><span class="w"> </span><span class="nc">TScopedLock</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="mo">03</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="mo">04</span><span class="w">     </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="mo">05</span><span class="w">         </span><span class="n">TScopedLock</span><span class="p">(</span><span class="n">Mutex</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">mx</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="mo">06</span><span class="w">         </span><span class="o">~</span><span class="n">TScopedLock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="mo">07</span><span class="w">     </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="mi">08</span><span class="w">         </span><span class="n">Mutex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mx</span><span class="p">;</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="mi">09</span><span class="w">     </span><span class="p">};</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="mi">10</span><span class="w"> </span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="mi">11</span><span class="w">     </span><span class="k">typedef</span><span class="w"> </span><span class="n">TScopedLock</span><span class="o">&lt;</span><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TMutexLocker</span><span class="p">;</span>
</span></code></pre></div>
<figcaption>
<p>Listing 8. Wrapper Class OS::TMutexLocker</p>
</figcaption>
</figure>
<p>The methodology for using objects of this class is no different from using other wrapper classesâ€”<code>TCritSect</code>, <code>TISRW</code>.</p>
<div class="admonition tip">
<p class="admonition-title"><strong>ABOUT PRIORITY INVERSION</strong></p>
<p>A few words should be said about a mechanism related to mutual exclusion semaphores: priority inversion.</p>
<p>The idea of priority inversion arises from the following situation. For example, a system has several processes, and processes with priorities N<sup id="fnref:17"><a class="footnote-ref" href="#fn:17">17</a></sup> and N+n, where n&gt;1, use the same resource, sharing work via a mutual exclusion semaphore. At some point, the process with priority N+n locks the semaphore and is working with the shared resource.</p>
<p>During this, an event occurs that activates the process with priority N, which attempts to access the shared resource and, in trying to lock the semaphore, transitions to a waiting state. It will remain in this state until the process with priority N+n unlocks the semaphore. The delay of the higher-priority process in this situation is forced, as it is impossible to take control away from the process with priority N+n without violating the logic of its work and the integrity of access to the shared resource. Knowing this, the developer typically tries to minimize the time spent working with the resource so that the low-priority process does not block the work of the high-priority one.</p>
<p>However, there is an unpleasant aspect to this situation: if at the moment described above a process with priority, for example, N+1, becomes active, it will preempt the process with priority N+n (since n&gt;1) and thereby introduce an additional delay for the waiting higher-priority process with priority N. The situation is aggravated by the fact that the program developer usually does not connect the work of the process with priority N+1 with the manipulations of processes with priorities N and N+n on the shared resource. Therefore, they might not consider optimizing the work of the process with priority N+1 in relation to this, which could completely block the work of the process with priority N for an unpredictable amount of time. This is a highly undesirable situation.</p>
<p>To avoid this, a technique called "priority inversion" is used. Its essence is that if a high-priority process attempts to lock a mutual exclusion semaphore that is already locked by a low-priority process, a temporary exchange of priorities occurs until the semaphore is unlocked. In effect, the low-priority process runs with the priority of the process that attempted to lock the semaphore. In this case, the situation described above, where a low-priority process blocks the work of a high-priority one, becomes impossible.</p>
</div>
<p>Despite the coherence and elegance of the priority inversion method, it is not without drawbacks. The main one is that its technical implementation incurs overhead comparable to or exceeding the cost of implementing the mutual exclusion semaphore functionality itself. It might turn out that switching process priorities and everything associated with itâ€”requiring consideration of all OS elements related to the priorities of processes involved in the inversionâ€”slows down the system to an unacceptable level.</p>
<p>In connection with this, the priority inversion mechanism is not used in the current version of <strong>scmRTOS</strong>. Instead, to solve the aforementioned problem of a high-priority process being blocked by a low-priority one, a task delegation mechanism is proposed, discussed in detail in "Appendix A Usage Examples, A.1 Task Queue." This represents a unified method for redistributing the execution of contextually related code among processes with different priorities.</p>
<hr />
<h2 id="osmessage">OS::message<a class="headerlink" href="#osmessage" title="Permanent link">ðŸ”—</a></h2>
<p><code>OS::message</code> is a C++ template for creating objects that implement inter-process communication by transmitting structured data. <code>OS::message</code> is similar to <code>OS::TEventFlag</code> and differs mainly in that, besides the flag itself, it also contains an object of an arbitrary type constituting the actual message body.</p>
<p>The template definition is shown in "Listing 9 OS::message".</p>
<p>As can be seen from the listing, the message template is built upon the <code>TBaseMessage</code> class. This is done for efficiency reasons, to avoid duplicating common code in template instancesâ€”the code common to all messages is moved to the level of the base class<sup id="fnref:18"><a class="footnote-ref" href="#fn:18">18</a></sup>.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TBaseMessage</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="mo">02</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="mo">03</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="mo">04</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TBaseMessage</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="mo">05</span><span class="w">   </span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="mo">06</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="w">  </span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="mo">07</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">send</span><span class="p">();</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="mi">08</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">send_isr</span><span class="p">();</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="mi">09</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_non_empty</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">;</span><span class="w">  </span><span class="p">}</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="mi">10</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reset</span><span class="w">       </span><span class="p">()</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">NonEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="mi">11</span><span class="w">   </span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="mi">12</span><span class="w">    </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="mi">13</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="mi">14</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="mi">15</span><span class="w">    </span><span class="p">};</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="mi">16</span><span class="w">   </span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="mi">17</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="mi">18</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TBaseMessage</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="mi">19</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="mi">20</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="mi">21</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">message</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TBaseMessage</span><span class="p">()</span><span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="mi">22</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="mi">23</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="mi">24</span><span class="w">            </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="mi">25</span><span class="w">            </span><span class="o">*</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="mi">26</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="mi">27</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="n">T</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="mi">28</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="mi">29</span><span class="w">            </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="mi">30</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="mi">31</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="mi">32</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="mi">33</span><span class="w">   </span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="mi">34</span><span class="w">    </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="mi">35</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Msg</span><span class="p">;</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="mi">36</span><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 9. OS::message</p>
</figcaption>
</figure>
<h3 id="interface_2">Interface<a class="headerlink" href="#interface_2" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="send"><u>send</u><a class="headerlink" href="#send" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_11">Prototype<a class="headerlink" href="#prototype_11" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">send</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_11">Description<a class="headerlink" href="#description_11" title="Permanent link">ðŸ”—</a></h6>
<p>Sends a message<sup id="fnref:19"><a class="footnote-ref" href="#fn:19">19</a></sup>. The operation involves transitioning processes waiting for the message to the ready state and calling the scheduler.</p>
<hr />
<h4 id="send-from-isr"><u>send from ISR</u><a class="headerlink" href="#send-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_12">Prototype<a class="headerlink" href="#prototype_12" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">send_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_12">Description<a class="headerlink" href="#description_12" title="Permanent link">ðŸ”—</a></h6>
<p>A variant of the above function optimized for use in interrupts. The function is inline and uses a special lightweight inline version of the scheduler. <strong><em>This variant must not be used outside of interrupt handler code</em></strong>.</p>
<hr />
<h4 id="wait_1"><u>wait</u><a class="headerlink" href="#wait_1" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_13">Prototype<a class="headerlink" href="#prototype_13" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">OS::TBaseMessage::wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_13">Description<a class="headerlink" href="#description_13" title="Permanent link">ðŸ”—</a></h6>
<p>Waits for a message<sup id="fnref:20"><a class="footnote-ref" href="#fn:20">20</a></sup>. The function checks if the message is non-empty. If it is non-empty, it returns <code>true</code>. If it is empty, it transitions the current process from the ready state to a state of waiting for this message.</p>
<p>If no argument is specified during the call or if the argument is 0, waiting will continue until some process sends a message or the current process is "awakened" using the <code>TBaseProcess::force_wake_up()</code> function<sup id="fnref:21"><a class="footnote-ref" href="#fn:21">21</a></sup>.</p>
<p>If an integer is specified as an argument, representing the timeout value expressed in system timer ticks, then waiting for the message will occur with a timeout, i.e., the process will be "awakened" in any case. If this happens before the timeout expires, meaning a message arrives before the timeout, the function returns <code>true</code>. Otherwise, i.e., if the timeout expires before the message is sent, the function returns <code>false</code>.</p>
<hr />
<h4 id="check-if-non-empty"><u>check if non-empty</u><a class="headerlink" href="#check-if-non-empty" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_14">Prototype<a class="headerlink" href="#prototype_14" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">is_non_empty</span><span class="p">();</span><span class="w"> </span>
</span></code></pre></div>
<h6 id="description_14">Description<a class="headerlink" href="#description_14" title="Permanent link">ðŸ”—</a></h6>
<p>The function returns <code>true</code> if a message has been sent, and <code>false</code> otherwise.</p>
<hr />
<h4 id="reset"><u>reset</u><a class="headerlink" href="#reset" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_15">Prototype<a class="headerlink" href="#prototype_15" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="nf">OS::TBaseMessage::reset</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_15">Description<a class="headerlink" href="#description_15" title="Permanent link">ðŸ”—</a></h6>
<p>The function resets the message, i.e., transitions it to the empty state. The message body remains unchanged.</p>
<hr />
<h4 id="write-message-contents"><u>write message contents</u><a class="headerlink" href="#write-message-contents" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_16">Prototype<a class="headerlink" href="#prototype_16" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_16">Description<a class="headerlink" href="#description_16" title="Permanent link">ðŸ”—</a></h6>
<p>Writes the actual message contents into the message object. The standard way to use <code>OS::message</code> is to write the message body and send the message using the <code>TBaseMessage::send()</code> functionâ€”see "Listing 10. Using OS::message".</p>
<hr />
<h4 id="access-message-body-by-reference"><u>access message body by reference</u><a class="headerlink" href="#access-message-body-by-reference" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_17">Prototype<a class="headerlink" href="#prototype_17" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="k">operator</span><span class="w"> </span><span class="n">T</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span></code></pre></div>
<h6 id="description_17">Description<a class="headerlink" href="#description_17" title="Permanent link">ðŸ”—</a></h6>
<p>Returns a constant reference to the message body. This facility should be used with caution, bearing in mind that while accessing the message body via a reference, it might be modified in another process (or interrupt handler). Therefore, it is recommended to use the <code>message::out()</code> function for reading the message body.</p>
<hr />
<h4 id="read-message-contents"><u>read message contents</u><a class="headerlink" href="#read-message-contents" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_18">Prototype<a class="headerlink" href="#prototype_18" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">out</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_18">Description<a class="headerlink" href="#description_18" title="Permanent link">ðŸ”—</a></h6>
<p>The function is intended for reading the message body. For efficiency, to avoid unnecessary copying of the message body, a reference to an external message body object is passed to the function. Inside the function, the message contents are copied into this external object.</p>
<hr />
<h3 id="usage-example_2">Usage Example<a class="headerlink" href="#usage-example_2" title="Permanent link">ðŸ”—</a></h3>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">TMamont</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w">           </span><span class="c1">//  data type for sending by message</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="mo">02</span><span class="w">    </span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="mo">03</span><span class="w">    </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">Mamont</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mamont_msg</span><span class="p">;</span><span class="w">  </span><span class="c1">// OS::message object</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="mo">04</span><span class="w">    </span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="mo">05</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="mo">06</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="mo">07</span><span class="w">        </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="mi">08</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="mi">09</span><span class="w">            </span><span class="n">Mamont</span><span class="w"> </span><span class="n">mamont</span><span class="p">;</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="mi">10</span><span class="w">            </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span><span class="w">      </span><span class="c1">// wait for message</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="mi">11</span><span class="w">            </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">out</span><span class="p">(</span><span class="n">mamont</span><span class="p">);</span><span class="w"> </span><span class="c1">// read message contents to the external object </span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="mi">12</span><span class="w">            </span><span class="p">...</span><span class="w">                     </span><span class="c1">// using the Mamont contents</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="mi">13</span><span class="w">        </span><span class="p">}</span><span class="w">     </span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="mi">14</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="mi">15</span><span class="w">    </span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="mi">16</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="mi">17</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="mi">18</span><span class="w">        </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="mi">19</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="mi">20</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="mi">21</span><span class="w">            </span><span class="n">Mamont</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w">           </span><span class="c1">// create message content</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="mi">22</span><span class="w">    </span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="mi">23</span><span class="w">            </span><span class="n">m</span><span class="p">...</span><span class="w">  </span><span class="o">=</span><span class="w">             </span><span class="c1">// message body filling</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="mi">24</span><span class="w">            </span><span class="n">mamont_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w">     </span><span class="c1">// put the content to the OS::message object</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="mi">25</span><span class="w">            </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">send</span><span class="p">();</span><span class="w">  </span><span class="c1">// send the message</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="mi">26</span><span class="w">            </span><span class="p">...</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="mi">27</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="mi">28</span><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 10. Using OS::message</p>
</figcaption>
</figure>
<hr />
<h2 id="oschannel">OS::channel<a class="headerlink" href="#oschannel" title="Permanent link">ðŸ”—</a></h2>
<p><code>OS::channel</code> is a C++ template for creating objects that implement ring buffers<sup id="fnref:22"><a class="footnote-ref" href="#fn:22">22</a></sup> for the safe transmission of data of arbitrary types within a preemptive OS. Like any other interprocess communication service, <code>OS::channel</code> solves synchronization problems. The specific buffer type is specified during the template instantiation<sup id="fnref:23"><a class="footnote-ref" href="#fn:23">23</a></sup> in the user code. The <code>OS::channel</code> template is based on the ring buffer template defined in the library included in the <strong>scmRTOS</strong> distribution:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">usr</span><span class="o">::</span><span class="n">ring_buffer</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="err">`</span>
</span></code></pre></div>
<p>Building channels using C++ templates provides an efficient means for constructing message queues of arbitrary types. Unlike the dangerous, non-transparent, and inflexible method of organizing message queues based on <code>void *</code> pointers, the <code>OS::channel</code> queue offers:</p>
<ul>
<li><strong>Safety through static type checking</strong>, both when creating the queue/channel and when writing data to it or reading from it.</li>
<li><strong>Ease of use</strong>â€”no need for manual type casting, which requires keeping extra information in mind about the real data types transmitted through the channel for their correct use.</li>
<li><strong>Significantly greater flexibility</strong>â€”queue objects can be of any type, not just pointers.</li>
</ul>
<p>Regarding the last point, a few words should be said: one drawback of using <code>void *</code> pointers as a basis for message passing is that the user must allocate memory for the messages themselves somewhere. This is extra work, and the target object becomes distributedâ€”the queue is in one place, while the actual content of the queue elements is elsewhere.</p>
<p>The main advantages of the pointer-based message mechanism are high efficiency for large message bodies and the ability to transmit messages of varying formats. However, if, for example, messages are smallâ€”a few bytesâ€”and all have the same format, there is no need for pointers. It's much simpler to create a queue of the required number of such messages, and that's it. In this case, as mentioned, there's no need to allocate memory for the message bodiesâ€”since messages are placed entirely into the channel queue, memory for them will be automatically allocated by the compiler directly when creating the channel.</p>
<p>The channel template definition is shown in "Listing 11. Definition of the OS::channel Template".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="mo">01</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="mo">02</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">channel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="mo">03</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="mo">04</span><span class="w">    </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="mo">05</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">channel</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProducersProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="mo">06</span><span class="w">                         </span><span class="p">,</span><span class="w"> </span><span class="n">ConsumersProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="mo">07</span><span class="w">                         </span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">()</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="mi">08</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="mi">09</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="mi">10</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="mi">11</span><span class="w">        </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="mi">12</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="mi">13</span><span class="w">        </span><span class="c1">//    Data transfer functions</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="mi">14</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="mi">15</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">cnt</span><span class="p">);</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="mi">16</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="mi">17</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="mi">18</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">push</span><span class="w">      </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="mi">19</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">push_front</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="mi">20</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="mi">21</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">pop</span><span class="w">     </span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="mi">22</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">pop_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="mi">23</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="mi">24</span><span class="w">        </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="mi">25</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="mi">26</span><span class="w">        </span><span class="c1">//    Service functions</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="mi">27</span><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="mi">28</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">get_count</span><span class="p">()</span><span class="w">     </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="mi">29</span><span class="w">        </span><span class="n">INLINE</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">get_free_size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="mi">30</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">flush</span><span class="p">();</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="mi">31</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="mi">32</span><span class="w">    </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="mi">33</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProducersProcessMap</span><span class="p">;</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="mi">34</span><span class="w">        </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ConsumersProcessMap</span><span class="p">;</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="mi">35</span><span class="w">        </span><span class="n">usr</span><span class="o">::</span><span class="n">ring_buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pool</span><span class="p">;</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="mi">36</span><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 11. Definition of the OS::channel Template</p>
</figcaption>
</figure>
<p><code>OS::channel</code> is used as follows: first, define the type of objects to be transmitted through the channel, then define the channel type or create a channel object. For example, suppose the data transmitted through the channel is a structure:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Data</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="p">{</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="kt">int</span><span class="w">   </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>Now, you can create a channel object by instantiating the <code>OS::channel</code> template:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_queue</span><span class="p">;</span>
</span></code></pre></div>
<p>This code declares a channel object <code>data_queue</code> for transmitting objects of type <code>Data</code>, with a channel capacity of 8 objects. The channel is now ready for use.</p>
<p><code>OS::channel</code> provides the ability to write data not only to the end of the queue but also to the beginning, and to read data not only from the beginning but also from the end of the queue. When reading, it is also possible to specify a timeout value.</p>
<p>The following interface is provided for operating on a channel object:</p>
<h3 id="interface_3">Interface<a class="headerlink" href="#interface_3" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="push"><u>push</u><a class="headerlink" href="#push" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_19">Prototype<a class="headerlink" href="#prototype_19" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">push</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_19">Description<a class="headerlink" href="#description_19" title="Permanent link">ðŸ”—</a></h6>
<p>Pushes one element to the end of the queue<sup id="fnref:24"><a class="footnote-ref" href="#fn:24">24</a></sup>. If there was space in the channel at the time of writing, the element is written to the queue and the scheduler is called. If there was no space, the process transitions to a waiting state until space becomes available in the channel. When space appears, the element will be written, followed by a call to the scheduler.</p>
<hr />
<h4 id="push-front"><u>push front</u><a class="headerlink" href="#push-front" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_20">Prototype<a class="headerlink" href="#prototype_20" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">push_front</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_20">Description<a class="headerlink" href="#description_20" title="Permanent link">ðŸ”—</a></h6>
<p>Pushes an element to the <strong>beginning</strong> of the queue. In all other respects, the logic of operation is exactly the same as for <code>channel::push()</code>.</p>
<hr />
<h4 id="pop"><u>pop</u><a class="headerlink" href="#pop" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_21">Prototype<a class="headerlink" href="#prototype_21" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_21">Description<a class="headerlink" href="#description_21" title="Permanent link">ðŸ”—</a></h6>
<p>Pops one element from the <strong>beginning</strong> of the queue if the channel was not empty. If the channel was empty, the process transitions to a waiting state until data appears in it <strong>or</strong> until the timeout expires, if a timeout was specified<sup id="fnref:25"><a class="footnote-ref" href="#fn:25">25</a></sup>.</p>
<p>In case of a call with a timeout: if data arrives before the timeout expires, the function returns <code>true</code>; otherwise, it returns <code>false</code>. If the call was made without a timeout, the function always returns <code>true</code>, except when awakened by <code>OS::TBaseProcess::wake_up()</code> or <code>OS::TBaseProcess::force_wake_up()</code>.</p>
<p>In all cases, when an element is popped, the scheduler is called.</p>
<p>Note that when calling this function, the data popped from the channel is not returned by copying from the function but is passed via a reference to an object. This is because the return value is used to convey the timeout result.</p>
<hr />
<h4 id="pop-back"><u>pop back</u><a class="headerlink" href="#pop-back" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_22">Prototype<a class="headerlink" href="#prototype_22" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">pop_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_22">Description<a class="headerlink" href="#description_22" title="Permanent link">ðŸ”—</a></h6>
<p>Pops one element from the <strong>end</strong> of the queue if the channel was not empty. All functionality is exactly the same as for <code>channel::pop()</code>.</p>
<hr />
<h4 id="write"><u>write</u><a class="headerlink" href="#write" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_23">Prototype<a class="headerlink" href="#prototype_23" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_23">Description<a class="headerlink" href="#description_23" title="Permanent link">ðŸ”—</a></h6>
<p>Writes several elements from memory at the given address to the <strong>end</strong> of the queue. Essentially, this is the same as pushing one element to the end of the queue (<code>push</code>), except that not one but the specified number of elements are written. In case of waiting, it continues until enough space becomes available in the channel.</p>
<hr />
<h4 id="write-inside-isr"><u>write inside ISR</u><a class="headerlink" href="#write-inside-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_24">Prototype<a class="headerlink" href="#prototype_24" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">write_isr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_24">Description<a class="headerlink" href="#description_24" title="Permanent link">ðŸ”—</a></h6>
<p>A special version for use inside interrupt handlers. The function writes as many elements as the free space in the channel allows (but no more than the specified count) and returns the number of elements written. Processes waiting for data from the channel are transitioned to the ready state.</p>
<p>The call is <strong>non-blocking</strong>. The scheduler is <strong>not</strong> called.</p>
<hr />
<h4 id="read"><u>read</u><a class="headerlink" href="#read" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_25">Prototype<a class="headerlink" href="#prototype_25" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">read</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_25">Description<a class="headerlink" href="#description_25" title="Permanent link">ðŸ”—</a></h6>
<p>Pops several elements from the channel. This is the same as <code>channel::pop()</code>, except that not one but the specified number of elements are popped. If waiting occurs, it continues until the required number of elements is available in the channel or until the timeout triggers (if used).</p>
<hr />
<h4 id="read-inside-isr"><u>read inside ISR</u><a class="headerlink" href="#read-inside-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_26">Prototype<a class="headerlink" href="#prototype_26" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">read_isr</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">max_size</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_26">Description<a class="headerlink" href="#description_26" title="Permanent link">ðŸ”—</a></h6>
<p>A special version for use inside interrupt handlers. The function reads as many elements as are present in the channel (but no more than the specified count) and returns the number of elements written. Processes waiting for free space to appear in the channel are transitioned to the ready state.</p>
<p>The call is <strong>non-blocking</strong>. The scheduler is <strong>not</strong> called.</p>
<hr />
<h4 id="get-item-count"><u>get item count</u><a class="headerlink" href="#get-item-count" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_27">Prototype<a class="headerlink" href="#prototype_27" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">get_count</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_27">Description<a class="headerlink" href="#description_27" title="Permanent link">ðŸ”—</a></h6>
<p>Returns the number of elements currently in the channel. The function is <strong>inline</strong>, so its efficiency is maximized.</p>
<hr />
<h4 id="get-free-size"><u>get free size</u><a class="headerlink" href="#get-free-size" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_28">Prototype<a class="headerlink" href="#prototype_28" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">get_free_size</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_28">Description<a class="headerlink" href="#description_28" title="Permanent link">ðŸ”—</a></h6>
<p>Returns the amount of free space available in the channel.</p>
<hr />
<h4 id="flush"><u>flush</u><a class="headerlink" href="#flush" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_29">Prototype<a class="headerlink" href="#prototype_29" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">flush</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_29">Description<a class="headerlink" href="#description_29" title="Permanent link">ðŸ”—</a></h6>
<p>Clears the channel. The function clears the buffer by calling <code>usr::ring_buffer&lt;&gt;::flush()</code> and calls the scheduler.</p>
<hr />
<h3 id="usage-example_3">Usage Example<a class="headerlink" href="#usage-example_3" title="Permanent link">ðŸ”—</a></h3>
<p>A simple usage example is shown in "Listing 12. Example of Using a Queue Based on a Channel".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="mo">01</span><span class="w">    </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="mo">02</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Cmd</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="mo">03</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="mo">04</span><span class="w">        </span><span class="k">enum</span><span class="w"> </span><span class="nc">CmdName</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cmdSetCoeff1</span><span class="p">,</span><span class="w"> </span><span class="n">cmdSetCoeff2</span><span class="p">,</span><span class="w"> </span><span class="n">cmdCheck</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">CmdName</span><span class="p">;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="mo">05</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">Value</span><span class="p">;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="mo">06</span><span class="w">    </span><span class="p">};</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="mo">07</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="mi">08</span><span class="w">    </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">Cmd</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cmd_q</span><span class="p">;</span><span class="w"> </span><span class="c1">// Queue for Commands with 10 items depth</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="mi">09</span><span class="w">    </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="mi">10</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="mi">11</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="mi">12</span><span class="w">        </span><span class="p">...</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="mi">13</span><span class="w">        </span><span class="n">Cmd</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cmdSetCoeff2</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="mi">14</span><span class="w">        </span><span class="n">cmd_q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="mi">15</span><span class="w">        </span><span class="p">...</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="mi">16</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="mi">17</span><span class="w">    </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="mi">18</span><span class="w">    </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="mi">19</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="mi">20</span><span class="w">        </span><span class="p">...</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="mi">21</span><span class="w">        </span><span class="n">Cmd</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="mi">22</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">cmd_q</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">// wait for data, timeout 10 system ticks</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="mi">23</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="mi">24</span><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// data incoming, do something</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="mi">25</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="mi">26</span><span class="w">        </span><span class="k">else</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="mi">27</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="mi">28</span><span class="w">            </span><span class="p">...</span><span class="w"> </span><span class="c1">// timeout expires, do something else</span>
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="mi">29</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="mi">30</span><span class="w">        </span><span class="p">...</span>
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="mi">31</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="mi">32</span><span class="w">    </span><span class="c1">//---------------------------------------------------------------------</span>
</span></code></pre></div>
<figcaption>
<p>Listing 12. Example of Using a Queue Based on a Channel.</p>
</figcaption>
</figure>
<p>As can be seen, usage is quite simple and transparent. In one process (Proc1), a command message <code>cmd</code> is created (13), initialized with the required values, and written to the channel queue (14). In another process (Proc2), there is a wait for data from the queue (22). If data arrives, the corresponding code is executed (23)-(25); if the timeout expires, different code is executed (27)-(29).</p>
<hr />
<h2 id="final-remarks">Final Remarks<a class="headerlink" href="#final-remarks" title="Permanent link">ðŸ”—</a></h2>
<p>There is a certain invariant relationship among different interprocess communication services. That is, using some services (or, more often, a combination thereof), you can accomplish the same task as with others. For example, instead of using a channel, you could create a static array and exchange data through it using mutual exclusion semaphores to prevent concurrent access and event flags to notify the waiting process that data is ready for it. In some cases, such an implementation might be more efficient, albeit less convenient.</p>
<p>You could use messages for event synchronization instead of event flagsâ€”this approach makes sense if you also need to transmit some information along with the flag. In fact, that's precisely what <code>OS::message</code> is designed for. The variety of uses is great, and which option is best suited for a particular situation is determined primarily by the situation itself.</p>
<div class="admonition info">
<p class="admonition-title"><strong>TIP</strong></p>
<p>It is necessary to understand and remember that any interprocess communication service, while performing its functions, does so within a critical section, i.e., with interrupts disabled. Therefore, you should not overuse interprocess communication services where they can be avoided.</p>
<p>For example, using a mutual exclusion semaphore when accessing a static variable of a built-in type is not a good idea compared to simply using a critical section, because the semaphore also uses critical sections when locking and unlocking, and the time spent in them is longer than during simple variable access.</p>
</div>
<p>There are certain peculiarities when using services within interrupts. For example, it is obvious that using <code>TMutex::lock()</code> inside an interrupt handler is a rather bad idea because, firstly, mutual exclusion semaphores are intended for resource sharing at the process level, not the interrupt level. Secondly, waiting for a resource to be released inside an interrupt handler will not work anyway and will only lead to the process interrupted by this interrupt being transitioned to a waiting state at an inappropriate and unpredictable point. Effectively, the process will be placed in an inactive state, from which it can only be recovered using the <code>TBaseProcess::force_wake_up()</code> function. In any case, nothing good will come of this.</p>
<p>A somewhat similar situation can arise when using channel objects in an interrupt handler. You cannot wait for data from a channel inside an ISR, and the consequences will be similar to those described above. Writing data to a channel is also not entirely safe. If, for instance, there is insufficient space in the channel when writing, the program's behavior will be far from what the user expects.</p>
<div class="admonition warning">
<p class="admonition-title"><strong>RECOMMENDATION</strong></p>
<p>For work inside interrupts, you should use the service member functions with the <code>_isr</code> suffixâ€”these are specially developed versions that ensure efficiency and safe use of interprocess communication services within interrupts.</p>
</div>
<p>And, of course, if the existing set of interprocess communication services does not meet the needs of a particular project for some reason, it is always possible to design a custom service class based on the provided foundation in the form of <code>TService</code>. In doing so, the standard set of services can serve as design examples.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Since interprocess communication services perform similar actions when interacting with kernel resources, they contain, in places, nearly identical code.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Or can be developed by the user for their project's needs.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>A process tag is technically a mask of type <code>TProcessMap</code> with only one non-zero bit. The position of this bit in the mask corresponds to the process priority. Process tags are used for manipulating <code>TProcessMap</code> objects, which define the ready/not-ready state of processes, and also serve to record process tags.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Along with the process priority number, the tag can also serve as a process identifierâ€”there is a one-to-one correspondence between the priority number and the process tag. Each type of identifier has advantages in terms of efficiency in specific situations, so both types are used extensively in the OS code.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>In other words, "awakened" in the system timer interrupt handler.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>That is, processes whose waiting state has not been interrupted by a timeout and/or forcibly using <code>TBaseProcess::wake_up()</code> and <code>TBaseProcess::force_wake_up()</code>.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>Therefore, a full description of them is not provided.&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p>Or an interrupt handlerâ€”depending on the source of the events. For interrupt handlers, there is a special version of the function that signals the flag, but in the context of the current description, this nuance is omitted as non-essential.&#160;<a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:9">
<p>The rest of its representation is auxiliary in nature and serves to give completeness to the class and improve its user characteristics.&#160;<a class="footnote-backref" href="#fnref:9" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:10">
<p>I.e., yield control to the system kernel and remain in passive waiting.&#160;<a class="footnote-backref" href="#fnref:10" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:11">
<p>Including when such events do not occur within the specified time interval.&#160;<a class="footnote-backref" href="#fnref:11" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:12">
<p>So that various parts of the program have access to it.&#160;<a class="footnote-backref" href="#fnref:12" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
<li id="fn:13">
<p>General rule: all processes working with a shared resource must behave this way, i.e., perform access through the semaphore.&#160;<a class="footnote-backref" href="#fnref:13" title="Jump back to footnote 13 in the text">&#8617;</a></p>
</li>
<li id="fn:14">
<p>A function that uses objects with non-local storage class during its operation. Therefore, to prevent disruption of the program's integrity, such a function must not be called if an instance of the same function is already running.&#160;<a class="footnote-backref" href="#fnref:14" title="Jump back to footnote 14 in the text">&#8617;</a></p>
</li>
<li id="fn:15">
<p>Sometimes translated as "deadly embrace."&#160;<a class="footnote-backref" href="#fnref:15" title="Jump back to footnote 15 in the text">&#8617;</a></p>
</li>
<li id="fn:16">
<p>Although nothing prevents placing a Mutex outside the process code's scope and using a pointer or reference, either directly or through wrapper classes that automate the resource unlocking process via the automatic call of the wrapper class's destructor.&#160;<a class="footnote-backref" href="#fnref:16" title="Jump back to footnote 16 in the text">&#8617;</a></p>
</li>
<li id="fn:17">
<p>It is assumed that process execution priority is inversely related to priority numbersâ€”i.e., the process with priority 0 is the highest priority, and as priority numbers increase, process priority decreases.&#160;<a class="footnote-backref" href="#fnref:17" title="Jump back to footnote 17 in the text">&#8617;</a></p>
</li>
<li id="fn:18">
<p>The same technique is used when building the process template: the pair <code>class TBaseProcess</code>&nbsp;â€“ <code>template process&lt;&gt;</code>.&#160;<a class="footnote-backref" href="#fnref:18" title="Jump back to footnote 18 in the text">&#8617;</a></p>
</li>
<li id="fn:19">
<p>Analogous to the <code>OS::TEventFlag::signal()</code> function.&#160;<a class="footnote-backref" href="#fnref:19" title="Jump back to footnote 19 in the text">&#8617;</a></p>
</li>
<li id="fn:20">
<p>Analogous to the <code>OS::TEventFlag::wait()</code> function.&#160;<a class="footnote-backref" href="#fnref:20" title="Jump back to footnote 20 in the text">&#8617;</a></p>
</li>
<li id="fn:21">
<p>In the latter case, extreme caution is required.&#160;<a class="footnote-backref" href="#fnref:21" title="Jump back to footnote 21 in the text">&#8617;</a></p>
</li>
<li id="fn:22">
<p>Functionally, it's a FIFO, i.e., a queue object for data transmission following the First In, First Out scheme.&#160;<a class="footnote-backref" href="#fnref:22" title="Jump back to footnote 22 in the text">&#8617;</a></p>
</li>
<li id="fn:23">
<p>Creation of a class instance.&#160;<a class="footnote-backref" href="#fnref:23" title="Jump back to footnote 23 in the text">&#8617;</a></p>
</li>
<li id="fn:24">
<p>Refers to the channel's queue. Functionally, since a channel is a FIFO, the end of the queue corresponds to the FIFO input, and the beginning of the channel corresponds to the FIFO output.&#160;<a class="footnote-backref" href="#fnref:24" title="Jump back to footnote 24 in the text">&#8617;</a></p>
</li>
<li id="fn:25">
<p>I.e., the call included a second argumentâ€”an integer specifying the timeout value in system timer ticks.&#160;<a class="footnote-backref" href="#fnref:25" title="Jump back to footnote 25 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../processes/" class="btn btn-neutral float-left" title="Processes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../ports/" class="btn btn-neutral float-right" title="Ports">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../processes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../ports/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/mathjax.js"></script>
      <script src="../../js/mathjax/tex-mml-chtml.js"></script>
      <script src="../../js/wavedrom.min.js"></script>
      <script src="../../js/wavedrom_loader.js"></script>
      <script src="../../js/wavedrom.unpkg.js"></script>
      <script src="../../js/wavedrom_skin_default.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
