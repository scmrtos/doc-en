<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Interprocess Communications - scmRTOS</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Interprocess Communications";
        var mkdocs_page_input_path = "src/ipcs.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> scmRTOS
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Intro</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Not a Preface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RTOS Components</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../kernel/">Kernel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../processes/">Processes</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Interprocess Communications</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tservice">TService</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#class-definition">Class Definition</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#preliminary-notes">Preliminary Notes</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#requirements-for-the-developed-class-functions">Requirements for the Developed Class Functions</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#osteventflag">OS::TEventFlag</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#wait">wait</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#signal">signal</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_1">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_1">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#signal-from-isr">signal from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_2">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_2">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#clear">clear</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_3">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_3">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#is_signaled">is_signaled</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_4">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_4">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ostmutex">OS::TMutex</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_1">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#lock">lock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_5">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_5">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#unlock">unlock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_6">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_6">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#unlock-from-isr">unlock from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_7">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_7">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#try-to-lock">try to lock</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_8">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_8">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#try-to-lock-with-timeout">try to lock with timeout</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_9">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_9">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#check-if-locked">check if locked</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_10">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_10">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_1">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#osmessage">OS::message</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_2">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#send">send</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_11">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_11">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#send-from-isr">send from ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_12">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_12">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#wait_1">wait</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_13">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_13">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#check-if-non-empty">check if non-empty</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_14">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_14">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#reset">reset</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_15">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_15">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-message-contents">write message contents</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_16">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_16">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#access-message-body-by-reference">access message body by reference</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_17">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_17">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-message-contents">read message contents</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_18">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_18">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_2">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#oschannel">OS::channel</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_3">Interface</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#push">push</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_19">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_19">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#push_front">push_front</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_20">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_20">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pop">pop</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_21">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_21">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pop_back">pop_back</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_22">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_22">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write">write</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_23">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_23">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#write-inside-isr">write inside ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_24">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_24">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read">read</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_25">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_25">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#read-inside-isr">read inside ISR</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_26">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_26">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#get-item-count">get item count</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_27">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_27">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#get-free-size">get free size</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_28">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_28">Description</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#flush">flush</a>
        <ul>
    <li class="toctree-l5"><a class="reference internal" href="#prototype_29">Prototype</a>
    </li>
    <li class="toctree-l5"><a class="reference internal" href="#description_29">Description</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage-example_3">Usage Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#concluding-remarks">Concluding Remarks</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ports/">Ports</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiler/">Process Performance Profiling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../example-job-queue/">Example: Job Queue</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">scmRTOS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">RTOS Components</li>
      <li class="breadcrumb-item active">Interprocess Communications</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="interprocesscommunicationservices">Interprocess<br>Communication<br>Services<a class="headerlink" href="#interprocesscommunicationservices" title="Permanent link">ðŸ”—</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">ðŸ”—</a></h2>
<p>Starting with version 4, <strong>scmRTOS</strong> employs a fundamentally different mechanism for implementing interprocess communication services compared to previous versions. Previously, each service class was developed individually with no relation to the others, and service classes were declared as "friends" of the kernel to access its resources. This approach prevented code reuse<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> and made it impossible to extend the set of services, leading to its abandonment in favor of a design free from both drawbacks.</p>
<p>The implementation is based on the concept of extending OS functionality through extension classes derived from <code>TKernelAgent</code> (see <a href="../kernel/#kernel-agent">"TKernelAgent and Extensions"</a>).</p>
<p>The key class for building interprocess communication services is <code>TService</code>, which implements the common functionality shared by all service classes. All service classesâ€”both those included in the standard <strong>scmRTOS</strong> distribution and those developed<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> as extensions to the standard setâ€”are derived from <code>TService</code>.</p>
<p>The interprocess communication services included in <strong>scmRTOS</strong> are:</p>
<ul>
<li><code>OS::TEventFlag</code>;</li>
<li><code>OS::TMutex</code>;</li>
<li><code>OS::message</code>;</li>
<li><code>OS::channel</code>;</li>
</ul>
<hr />
<h2 id="tservice">TService<a class="headerlink" href="#tservice" title="Permanent link">ðŸ”—</a></h2>
<h3 id="class-definition">Class Definition<a class="headerlink" href="#class-definition" title="Permanent link">ðŸ”—</a></h3>
<p>The code for the base class used to build service types:</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TService</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="n">TKernelAgent</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="mo">03</span><span class="w"> </span><span class="k">protected</span><span class="o">:</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="mo">04</span><span class="w">     </span><span class="n">TService</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TKernelAgent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="mo">05</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="mo">06</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">cur_proc_prio_tag</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">get_prio_tag</span><span class="p">(</span><span class="n">cur_proc_priority</span><span class="p">());</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="mo">07</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">highest_prio_tag</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">map</span><span class="p">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="mi">08</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="mi">09</span><span class="w"> </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_PRIORITY_ORDER</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="mi">10</span><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Isolate rightmost 1-bit.</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="mi">11</span><span class="w"> </span><span class="err">#</span><span class="k">else</span><span class="w"> </span><span class="c1">// scmRTOS_PRIORITY_ORDER == 1</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="mi">12</span><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">get_prio_tag</span><span class="p">(</span><span class="n">highest_priority</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="mi">13</span><span class="w"> </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="mi">14</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="mi">15</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="mi">16</span><span class="w">     </span><span class="c1">//----------------------------------------------------------------------</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="mi">17</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="mi">18</span><span class="w">     </span><span class="c1">// Base API</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="mi">19</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="mi">20</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="mi">21</span><span class="w">     </span><span class="c1">// add prio_tag proc to waiters map, reschedule</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="mi">22</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">suspend</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="mi">23</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="mi">24</span><span class="w">     </span><span class="c1">// returns false if waked-up by timeout or TBaseProcess::wake_up() | force_wake_up()</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="mi">25</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_timeouted</span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="mi">26</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="mi">27</span><span class="w">     </span><span class="c1">// wake-up all processes from waiters map</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="mi">28</span><span class="w">     </span><span class="c1">// return false if no one process was waked-up</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="mi">29</span><span class="w">     </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_all</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="mi">30</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_all_isr</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="mi">31</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="mi">32</span><span class="w">     </span><span class="c1">// wake-up next ready (most priority) process from waiters map if any</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="mi">33</span><span class="w">     </span><span class="c1">// return false if no one process was waked-up</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="mi">34</span><span class="w">     </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_next_ready</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="mi">35</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">resume_next_ready_isr</span><span class="w"> </span><span class="p">(</span><span class="n">TProcessMap</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">waiters_map</span><span class="p">);</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="mi">36</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 1. TService  </p>
</figcaption>
</figure>
<p>Like its parent class <code>TKernelAgent</code>, the <code>TService</code> class does not allow instantiation of objects of its own type: its purpose is to provide a base for constructing concrete typesâ€”interprocess communication services. The interface of this class consists of a set of functions that express the common actions performed by any service class in the context of control transfer between processes. Logically, these functions can be divided into two groups: core and auxiliary.</p>
<p>The auxiliary functions include:</p>
<ol>
<li><code>TService::cur_proc_prio_tag()</code>. Returns the tag<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> corresponding to the currently active process. This tag is actively used by the core service functions to record process identifiers<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup> when placing the current process into a waiting state.</li>
<li><code>TService::highest_prio_tag()</code>. Returns the tag of the highest-priority process from the process map passed as an argument. It is primarily used to obtain the identifier (of the process) from those recorded in the service object's process map, identifying the process that should be marked ready to run.</li>
</ol>
<p>The core functions are:</p>
<ol>
<li><code>TService::suspend()</code>. Places the process into an unready state, records the process identifier in the service's process map, and invokes the OS scheduler. This function forms the basis for service member functions used to wait for an event (<code>wait()</code>, <code>pop()</code>, <code>read()</code>) or for actions that may involve waiting for resource release (<code>lock()</code>, <code>push()</code>, <code>write()</code>).</li>
<li><code>TService::is_timeouted()</code>. Returns <code>false</code> if the process was marked ready via a service member function call; returns <code>true</code> if the process was marked ready due to timeout expiration<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup> or forcibly via <code>TBaseProcess</code> member functions <code>wake_up()</code> or <code>force_wake_up()</code>. The result is used to determine whether the process successfully waited for the expected event (or resource release) or not.</li>
<li><code>TService::resume_all()</code>. Checks for processes recorded in the service's process map that are in an unready state<sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>; if any exist, all are marked ready and the scheduler is invoked. The function returns <code>true</code> in this case, otherwise <code>false</code>.</li>
<li><code>TService::resume_next_ready()</code>. Performs actions similar to <code>resume_all()</code>, but with the difference that, when waiting processes are present, only oneâ€”the highest-priorityâ€”is marked ready instead of all.</li>
</ol>
<p>For the <code>resume_all()</code> and <code>resume_next_ready()</code> functions, there are versions optimized for use inside interrupt handlersâ€”<code>resume_all_isr()</code> and <code>resume_next_ready_isr()</code>. In purpose and semantics, they resemble the main variants<sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>; the primary difference is that they do not invoke the scheduler.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">ðŸ”—</a></h3>
<h4 id="preliminary-notes">Preliminary Notes<a class="headerlink" href="#preliminary-notes" title="Permanent link">ðŸ”—</a></h4>
<p>Any service class is created by inheriting from <code>TService</code>. As an example of using <code>TService</code> and building a service class upon it, one of the standard interprocess communication servicesâ€”<code>TEventFlag</code>â€”will be examined:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TEventFlag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>The <code>TEventFlag</code> service class itself will be described in detail later; for narrative continuity, it should be noted here that this interprocess communication service is used to synchronize process operation with occurring events. The basic usage idea: one process waits for an event using the <code>TEventFlag::wait()</code> member function, while another process<sup id="fnref:8"><a class="footnote-ref" href="#fn:8">8</a></sup> signals the flag using <code>TEventFlag::signal()</code> when the event that needs handling in the waiting process occurs.</p>
<p>Given the above, primary attention in this example will focus on these two functions, as they carry the main semantic load of the service class<sup id="fnref:9"><a class="footnote-ref" href="#fn:9">9</a></sup> and its development largely reduces to implementing such functions.</p>
<h4 id="requirements-for-the-developed-class-functions">Requirements for the Developed Class Functions<a class="headerlink" href="#requirements-for-the-developed-class-functions" title="Permanent link">ðŸ”—</a></h4>
<p>Requirements for the event flag wait function: The function must check whether the event has already occurred at the moment of call and, if not, be capable of waiting<sup id="fnref:10"><a class="footnote-ref" href="#fn:10">10</a></sup> for the event either unconditionally or with a timeout condition. Return <code>true</code> if exiting due to the event; return <code>false</code> if exiting due to timeout.</p>
<p>Requirements for the event flag signal function: The function must mark all processes waiting for the event flag as ready to run and transfer control to the scheduler.</p>
<h4 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">ðŸ”—</a></h4>
<p>Inside the <code>wait()</code> member functionâ€”see "Listing 2. TEventFlag::wait()"â€”the first step is to check whether the event has already been signaled; if so, the function returns <code>true</code>. If the event has not been signaled (i.e., it needs to be awaited), preparatory actions are performedâ€”in particular, the wait timeout value is written to the current process's <code>Timeout</code> variable, and the <code>suspend()</code> function defined in the base class <code>TService</code> is called. This function records the current process tag in the event flag object's process map (passed as an argument to <code>suspend()</code>), marks the process unready, and yields control to other processes by invoking the scheduler.</p>
<p>Upon return from <code>suspend()</code>â€”meaning the process has been marked readyâ€”a check determines the source of the awakening. This is done by calling <code>is_timeouted()</code>, which returns <code>false</code> if the process was awakened via <code>TEventFlag::signal()</code> (i.e., the expected event occurred without timeout) and <code>true</code> if awakening occurred due to the timeout specified in the <code>TEventFlag::wait()</code> argument or forcibly.</p>
<p>This logic for the <code>TEventFlag::wait()</code> member function enables efficient use in user code when organizing process operation synchronized with required events<sup id="fnref:11"><a class="footnote-ref" href="#fn:11">11</a></sup>, while keeping the implementation code simple and transparent.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="mo">01</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="mo">03</span><span class="w">     </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="mo">04</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="mo">05</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="c1">// if flag already signaled</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="mo">06</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="mo">07</span><span class="w">         </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">;</span><span class="w"> </span><span class="c1">// clear flag</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="mi">08</span><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="mi">09</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="mi">10</span><span class="w">     </span><span class="k">else</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="mi">11</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="mi">12</span><span class="w">         </span><span class="n">cur_proc_timeout</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="mi">13</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="mi">14</span><span class="w">         </span><span class="n">suspend</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">);</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="mi">15</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="mi">16</span><span class="w">         </span><span class="k">if</span><span class="p">(</span><span class="n">is_timeouted</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">))</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="mi">17</span><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// waked up by timeout or by externals</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="mi">18</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="mi">19</span><span class="w">         </span><span class="n">cur_proc_timeout</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="mi">20</span><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// otherwise waked up by signal() or signal_isr()</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="mi">21</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="mi">22</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 2. The TEventFlag::wait() Function  </p>
</figcaption>
</figure>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="mi">1</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal</span><span class="p">()</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="mi">2</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="mi">3</span><span class="w">     </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="mi">4</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">resume_all</span><span class="p">(</span><span class="n">ProcessMap</span><span class="p">))</span><span class="w"> </span><span class="c1">// if no one process was waiting for flag</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="mi">5</span><span class="w">         </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOn</span><span class="p">;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="mi">6</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 3. The TEventFlag::signal() Function  </p>
</figcaption>
</figure>
<p>The code for <code>TEventFlag::signal()</code>â€”see "Listing 3. TEventFlag::signal()"â€”is extremely simple: it marks all processes waiting for this event flag as ready and performs rescheduling. If none were waiting, the internal event flag variable <code>efOn</code> is set to <code>true</code>, indicating that the event occurred but has not yet been handled.</p>
<p>Any interprocess communication service can be designed and implemented in a similar manner. During development, it is only necessary to clearly understand what the <code>TService</code> member functions do and use them appropriately.</p>
<hr />
<h2 id="osteventflag">OS::TEventFlag<a class="headerlink" href="#osteventflag" title="Permanent link">ðŸ”—</a></h2>
<p>In program execution, it is often necessary to synchronize processes. For example, one process must wait for an event before continuing its work. This can be handled in various ways: the process might continuously poll a global flag in a tight loop, or it could poll periodicallyâ€”check the flag, sleep with a timeout, wake up, check again, and so on. The first approach is poor because the polling process, due to its tight loop, prevents lower-priority processes from receiving any CPU timeâ€”they cannot preempt the polling process despite their lower priorities.</p>
<p>The second approach is also suboptimal: the polling period is relatively large (resulting in low temporal resolution), and during each poll the process consumes CPU cycles solely for context switching, even though it is unknown whether the event has occurred.</p>
<p>A proper solution is to place the process into a waiting state for the event and transfer control to it only when the event actually occurs.</p>
<p>This functionality in <strong>scmRTOS</strong> is provided by <code>OS::TEventFlag</code> objects (event flags). The class definition is shown in "Listing 4. OS::TEventFlag".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TEventFlag</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="mo">03</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="mo">04</span><span class="w">     </span><span class="k">enum</span><span class="w"> </span><span class="nc">TValue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">efOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">efOff</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// prefix &#39;ef&#39; means: &quot;Event Flag&quot;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="mo">05</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="mo">06</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="mo">07</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TEventFlag</span><span class="p">(</span><span class="n">TValue</span><span class="w"> </span><span class="n">init_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">);</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="mi">08</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="mi">09</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="mi">10</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">signal</span><span class="p">();</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="mi">11</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">clear</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">efOff</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="mi">12</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">signal_isr</span><span class="p">();</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="mi">13</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_signaled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">efOn</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="mi">14</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="mi">15</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="mi">16</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="mi">17</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TValue</span><span class="w"> </span><span class="n">Value</span><span class="p">;</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="mi">18</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 4. OS::TEventFlag  </p>
</figcaption>
</figure>
<h3 id="interface">Interface<a class="headerlink" href="#interface" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="wait"><u>wait</u><a class="headerlink" href="#wait" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype">Prototype<a class="headerlink" href="#prototype" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">OS::TEventFlag::wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description">Description<a class="headerlink" href="#description" title="Permanent link">ðŸ”—</a></h6>
<p>Wait for an event. When <code>wait()</code> is called, the following occurs: the flag is checked to see if it is set. If it is, the flag is cleared and the function returns <code>true</code>, meaning the event had already occurred at the time of the call. If the flag is not set (i.e., the event has not yet occurred), the process is placed into a waiting state for this flag (event), and control is yielded to the kernel, which reschedules processes and runs the next ready one.</p>
<p>If the function is called without an argument (or with an argument of 0), the process will remain waiting until the event flag is signaled by another process or an interrupt handler (using <code>signal()</code>) or until it is forcibly awakened using <code>TBaseProcess::force_wake_up()</code> (the latter should be used with extreme caution).</p>
<p>When <code>wait()</code> is called without an argument, it always returns <code>true</code>. If called with a positive integer argument representing a timeout in system timer ticks, the process waits as described, but if the event flag is not signaled within the specified period, the process is awakened by the timer and the function returns <code>false</code>. This implements both unconditional waiting and waiting with timeout.</p>
<hr />
<h4 id="signal"><u>signal</u><a class="headerlink" href="#signal" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_1">Prototype<a class="headerlink" href="#prototype_1" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_1">Description<a class="headerlink" href="#description_1" title="Permanent link">ðŸ”—</a></h6>
<p>A process that wishes to notify other processes via a <code>TEventFlag</code> object that a particular event has occurred must call <code>signal()</code>. This marks all processes waiting for the event as ready to run, and control is immediately transferred to the highest-priority one among them (the others will run in priority order).</p>
<hr />
<h4 id="signal-from-isr"><u>signal from ISR</u><a class="headerlink" href="#signal-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_2">Prototype<a class="headerlink" href="#prototype_2" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">signal_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_2">Description<a class="headerlink" href="#description_2" title="Permanent link">ðŸ”—</a></h6>
<p>A version of the above function optimized for use in interrupt service routines. The function is inline and uses a special lightweight inline version of the scheduler. This variant must not be used outside interrupt handler code.</p>
<hr />
<h4 id="clear"><u>clear</u><a class="headerlink" href="#clear" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_3">Prototype<a class="headerlink" href="#prototype_3" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">clear</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_3">Description<a class="headerlink" href="#description_3" title="Permanent link">ðŸ”—</a></h6>
<p>Clear the flag. Sometimes synchronization requires waiting for the <em>next</em> event rather than processing one that has already occurred. In such cases, the event flag must be cleared before starting the wait. The <code>clear()</code> function serves this purpose.</p>
<hr />
<h4 id="is_signaled"><u>is_signaled</u><a class="headerlink" href="#is_signaled" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_4">Prototype<a class="headerlink" href="#prototype_4" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="o">::</span><span class="n">is_signaled</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_4">Description<a class="headerlink" href="#description_4" title="Permanent link">ðŸ”—</a></h6>
<p>Check the flag state. It is not always necessary to wait for an event by yielding control. Sometimes the program logic only requires checking whether the event has occurred.</p>
<hr />
<h3 id="usage-example">Usage Example<a class="headerlink" href="#usage-example" title="Permanent link">ðŸ”—</a></h3>
<p>An example of using an event flag is shown in "Listing 5. Using TEventFlag".</p>
<p>In this example, process <code>Proc1</code> waits for an event with a timeout of 10 system timer ticks (line 9). The second processâ€”<code>Proc2</code>â€”signals the flag when a condition is met (line 27). If the first process has higher priority, it will immediately receive control.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="mo">01</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TEventFlag</span><span class="w"> </span><span class="n">eflag</span><span class="p">;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="mo">03</span><span class="w"> </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="mo">04</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="mo">05</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="mo">06</span><span class="w">     </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="mo">07</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="mi">08</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="mi">09</span><span class="w">         </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eflag</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">// wait event for 10 ticks</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="mi">10</span><span class="w">         </span><span class="p">{</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="mi">11</span><span class="w">             </span><span class="p">...</span><span class="w"> </span><span class="c1">// do something</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="mi">12</span><span class="w">         </span><span class="p">}</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="mi">13</span><span class="w">         </span><span class="k">else</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="mi">14</span><span class="w">         </span><span class="p">{</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="mi">15</span><span class="w">             </span><span class="p">...</span><span class="w"> </span><span class="c1">// do something else</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="mi">16</span><span class="w">         </span><span class="p">}</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="mi">17</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="mi">18</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="mi">19</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="mi">20</span><span class="w"> </span><span class="p">...</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="mi">21</span><span class="w"> </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="mi">22</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="mi">23</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="mi">24</span><span class="w">     </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="mi">25</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="mi">26</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="mi">27</span><span class="w">         </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">eflag</span><span class="p">.</span><span class="n">signal</span><span class="p">();</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="mi">28</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="mi">29</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="mi">30</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="mi">31</span><span class="w"> </span><span class="c1">//----------------------------------------------------------------</span>
</span></code></pre></div>
<figcaption>
<p>Listing 5. Using TEventFlag  </p>
</figcaption>
</figure>
<div class="admonition info">
<p class="admonition-title"><strong>NOTE</strong></p>
<p>When an event occurs and a process signals the flag, <strong>all</strong> processes waiting for that flag are marked ready to run. In other words, every process that was waiting will be awakened. They will, of course, receive control in order of their priorities, but no process that had already entered the wait state will miss the event, regardless of its priority.</p>
<p>Thus, the event flag <strong>possesses a broadcast property</strong>, which is very useful for notifying and synchronizing multiple processes on a single event. Naturally, nothing prevents using an event flag in a point-to-point manner, where only one process is waiting for the event.</p>
</div>
<hr />
<h2 id="ostmutex">OS::TMutex<a class="headerlink" href="#ostmutex" title="Permanent link">ðŸ”—</a></h2>
<p>A <strong>Mutex</strong> semaphore (from <em>Mutual Exclusion</em>) is designed, as its name suggests, to enforce mutual exclusion in access. At any given moment, only one process may hold (own) the mutex. If another process attempts to acquire a mutex that is already held by a different process, the attempting process will wait until the mutex is released.</p>
<p>The primary use of mutex semaphores is to provide mutual exclusion when accessing shared resources. For example, consider a static array with global scope<sup id="fnref:12"><a class="footnote-ref" href="#fn:12">12</a></sup> through which two processes exchange data. To prevent errors during the exchange, access to the array must be exclusiveâ€”one process must not be allowed to access it while the other is working with it.</p>
<p>Using a critical section for this purpose is not ideal, because interrupts would be disabled for the entire duration of the array access, which can be significant. During this time, the system would be unable to respond to events. A mutual-exclusion semaphore is far better suited here: the process intending to work with the shared resource must first acquire the mutex. Once acquired, it can safely manipulate the resource.</p>
<p>Upon completion, the process must release the mutex so that other processes can gain access. It goes without saying that <strong>all</strong> processes accessing the shared resource must follow this disciplineâ€”accessing it only through the mutex<sup id="fnref:13"><a class="footnote-ref" href="#fn:13">13</a></sup>.</p>
<p>The same considerations fully apply to calling non-reentrant<sup id="fnref:14"><a class="footnote-ref" href="#fn:14">14</a></sup> functions.</p>
<div class="admonition warning">
<p class="admonition-title"><strong>WARNING</strong></p>
<p>When using mutual-exclusion semaphores, a <strong>deadlock</strong> situation (sometimes translated as "deadly embrace") can arise. Imagine one process holds Mutex A and attempts to acquire Mutex B, while another process holds Mutex B and attempts to acquire Mutex A. Both processes end up waiting indefinitely for the other to release its mutex.</p>
<p>This is known as a <em>deadlock</em> (in English literature, simply "deadlock"). To avoid it, the programmer must carefully manage access to shared resources. A good rule that prevents such situations is to <strong>never hold more than one mutex at a time</strong>. In any case, success depends on the developer's attention and discipline.</p>
</div>
<p>Binary semaphores of this type are implemented in <strong>scmRTOS</strong> by the class <code>OS::TMutex</code>â€”see "Listing 6. OS::TMutex".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TMutex</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="mo">03</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="mo">04</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TMutex</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">ValueTag</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="mo">05</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">lock</span><span class="p">();</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="mo">06</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">unlock</span><span class="p">();</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="mo">07</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">unlock_isr</span><span class="p">();</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="mi">08</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="mi">09</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">try_lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">ValueTag</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="mi">10</span><span class="w">     </span><span class="k">else</span><span class="w"> </span><span class="n">lock</span><span class="p">();</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="mi">11</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_locked</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ValueTag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="mi">12</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="mi">13</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="mi">14</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="mi">15</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ValueTag</span><span class="p">;</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="mi">16</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="mi">17</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 6. OS::TMutex  </p>
</figcaption>
</figure>
<p>Obviously, a mutex must be created before use. Due to its purpose, the mutex should have the same storage class and visibility as the resource it protectsâ€”typically a static object with global scope<sup id="fnref:16"><a class="footnote-ref" href="#fn:16">16</a></sup>.</p>
<h3 id="interface_1">Interface<a class="headerlink" href="#interface_1" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="lock"><u>lock</u><a class="headerlink" href="#lock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_5">Prototype<a class="headerlink" href="#prototype_5" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">TMutex::lock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_5">Description<a class="headerlink" href="#description_5" title="Permanent link">ðŸ”—</a></h6>
<p>Performs a <strong>blocking</strong> acquire: if the mutex is currently free, its internal state is set to locked and control returns to the caller. If the mutex is already held, the calling process is placed in a waiting state until the mutex is released, and control is yielded to the kernel.</p>
<hr />
<h4 id="unlock"><u>unlock</u><a class="headerlink" href="#unlock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_6">Prototype<a class="headerlink" href="#prototype_6" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">TMutex::unlock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_6">Description<a class="headerlink" href="#description_6" title="Permanent link">ðŸ”—</a></h6>
<p>Sets the internal state to unlocked and checks whether any other process is waiting for this mutex. If so, control is yielded to the kernel for reschedulingâ€”the highest-priority waiting process will receive control immediately if it has higher priority. If multiple processes are waiting, the highest-priority one runs next. <strong>Only the process that locked the mutex can unlock it</strong>â€”calling <code>unlock()</code> from a different process has no effect and leaves the mutex locked.</p>
<hr />
<h4 id="unlock-from-isr"><u>unlock from ISR</u><a class="headerlink" href="#unlock-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_7">Prototype<a class="headerlink" href="#prototype_7" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">unlock_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_7">Description<a class="headerlink" href="#description_7" title="Permanent link">ðŸ”—</a></h6>
<p>Sometimes a mutex is locked in a process, but the actual work with the protected resource occurs in an interrupt handler (initiated by the process after locking). In such cases, it is convenient to unlock directly from the ISR upon completion. The <code>unlock_isr()</code> function is provided for this purpose.</p>
<hr />
<h4 id="try-to-lock"><u>try to lock</u><a class="headerlink" href="#try-to-lock" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_8">Prototype<a class="headerlink" href="#prototype_8" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">try_lock</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_8">Description<a class="headerlink" href="#description_8" title="Permanent link">ðŸ”—</a></h6>
<p><strong>Non-blocking</strong> acquire. Unlike <code>lock()</code>, acquisition occurs only if the mutex is currently free. This is useful when a process has other work to do and does not want to block indefinitely. For example, a high-priority process might prefer to perform alternative tasks while a lower-priority process holds the mutex, rather than yielding control.</p>
<p>Use this function cautiouslyâ€”excessive use in high-priority processes can starve lower-priority ones, preventing them from ever releasing the mutex.</p>
<hr />
<h4 id="try-to-lock-with-timeout"><u>try to lock with timeout</u><a class="headerlink" href="#try-to-lock-with-timeout" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_9">Prototype<a class="headerlink" href="#prototype_9" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="o">::</span><span class="n">try_lock</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_9">Description<a class="headerlink" href="#description_9" title="Permanent link">ðŸ”—</a></h6>
<p>Blocking acquire limited to the specified timeout interval. Returns <code>true</code> if the mutex was acquired, <code>false</code> otherwise.</p>
<hr />
<h4 id="check-if-locked"><u>check if locked</u><a class="headerlink" href="#check-if-locked" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_10">Prototype<a class="headerlink" href="#prototype_10" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">TMutex</span><span class="o">::</span><span class="n">is_locked</span><span class="p">()</span>
</span></code></pre></div>
<h6 id="description_10">Description<a class="headerlink" href="#description_10" title="Permanent link">ðŸ”—</a></h6>
<p>Returns <code>true</code> if the mutex is currently locked, <code>false</code> otherwise. Sometimes a mutex is used as a simple state flagâ€”one process sets it (by locking), while others check the state and react accordingly.</p>
<hr />
<h3 id="usage-example_1">Usage Example<a class="headerlink" href="#usage-example_1" title="Permanent link">ðŸ”—</a></h3>
<p>An example is shown in "Listing 7. Example of Using OS::TMutex".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="mo">01</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="w"> </span><span class="n">Mutex</span><span class="p">;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="mo">02</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="mo">03</span><span class="w"> </span><span class="p">...</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="mo">04</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">TSlon</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="mo">05</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="mo">06</span><span class="w">     </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="mo">07</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="mi">08</span><span class="w">         </span><span class="p">...</span><span class="w"> </span><span class="c1">// some code</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="mi">09</span><span class="w">         </span><span class="c1">//</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="mi">10</span><span class="w">         </span><span class="n">Mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w"> </span><span class="c1">// resource access lock</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="mi">11</span><span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">//</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="mi">12</span><span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="c1">//</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="mi">13</span><span class="w">             </span><span class="p">...</span><span class="w"> </span><span class="c1">// do something with buf</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="mi">14</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="c1">//</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="mi">15</span><span class="w">         </span><span class="n">Mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"> </span><span class="c1">// resource access unlock</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="mi">16</span><span class="w">         </span><span class="c1">//</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="mi">17</span><span class="w">         </span><span class="p">...</span><span class="w"> </span><span class="c1">// some code</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="mi">18</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="mi">19</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 7. Example of Using OS::TMutex  </p>
</figcaption>
</figure>
<p>For convenient mutex usage, the well-known wrapper-class technique can be applied via <code>TMutexLocker</code> (included in the distribution)â€”see "Listing 8. Wrapper Class OS::TMutexLocker".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Mutex</span><span class="o">&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="mo">02</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TScopedLock</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="mo">03</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="mo">04</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="mo">05</span><span class="w">     </span><span class="n">TScopedLock</span><span class="p">(</span><span class="n">Mutex</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">mx</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="mo">06</span><span class="w">     </span><span class="o">~</span><span class="n">TScopedLock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mx</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="mo">07</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="mi">08</span><span class="w">     </span><span class="n">Mutex</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mx</span><span class="p">;</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="mi">09</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="mi">10</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="mi">11</span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="n">TScopedLock</span><span class="o">&lt;</span><span class="n">OS</span><span class="o">::</span><span class="n">TMutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TMutexLocker</span><span class="p">;</span>
</span></code></pre></div>
<figcaption>
<p>Listing 8. Wrapper Class OS::TMutexLocker  </p>
</figcaption>
</figure>
<p>The usage methodology is identical to other wrappers such as <code>TCritSect</code> and <code>TISRW</code>.</p>
<p><a name="mutex-priority-inversion"></a></p>
<div class="admonition tip">
<p class="admonition-title"><strong>ON PRIORITY INVERSION</strong></p>
<p>A few words about <strong>priority inversion</strong>, a phenomenon related to mutual-exclusion semaphores.</p>
<p>Consider a system with processes of priorities N<sup id="fnref:17"><a class="footnote-ref" href="#fn:17">17</a></sup> and N+n (n&gt;1) sharing a resource protected by a mutex. The higher-priority process (N) attempts to acquire the mutex while the lower-priority process (N+n) already holds it and is working with the resource. The high-priority process must waitâ€”an unavoidable delay, as preempting the low-priority process would corrupt resource integrity. Developers typically minimize the critical section duration to limit this delay.</p>
<p>The problem arises when a medium-priority process (e.g., N+1) becomes ready: it preempts the low-priority holder (N+n), further delaying the high-priority waiter (N). Since the medium-priority process is unrelated to the shared resource, its execution time may not be optimized, potentially blocking the high-priority process indefinitelyâ€”an undesirable situation.</p>
<p>To prevent this, <strong>priority inheritance</strong> is used: when a high-priority process waits on a mutex held by a low-priority process, the holder temporarily inherits the waiterâ€™s priority until it releases the mutex. This eliminates unbounded blocking.</p>
</div>
<p>Despite its elegance, priority inheritance has drawbacks: implementation overhead can be comparable to or exceed that of the mutex itself, and the required modifications across the OS (all priority-related components) may unacceptably degrade performance.</p>
<p>For these reasons, the current version of <strong>scmRTOS</strong> does not implement priority inheritance. Instead, the problem is addressed via <strong>task delegation</strong>, described in detail in Appendix (<a href="../example-job-queue/">Example: Job Queue</a>), which provides a unified method for redistributing context-related code execution across processes of different priorities.</p>
<hr />
<h2 id="osmessage">OS::message<a class="headerlink" href="#osmessage" title="Permanent link">ðŸ”—</a></h2>
<p><code>OS::message</code> is a C++ template for creating objects that enable interprocess communication by exchanging structured data. <code>OS::message</code> is similar to <code>OS::TEventFlag</code>, with the main difference being that, in addition to the flag itself, it also contains an object of an arbitrary type that forms the actual message payload.</p>
<p>The template definition is shown in "Listing 9. OS::message".</p>
<p>As can be seen from the listing, the message template is built upon the <code>TBaseMessage</code> class. This is done for efficiency reasonsâ€”to avoid duplicating common code across template instantiations. The code shared by all messages is factored out into the base class<sup id="fnref:18"><a class="footnote-ref" href="#fn:18">18</a></sup>.</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TBaseMessage</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="mo">02</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="mo">03</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="mo">04</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">TBaseMessage</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="mo">05</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="mo">06</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="mo">07</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">send</span><span class="p">();</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="mi">08</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">send_isr</span><span class="p">();</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="mi">09</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_non_empty</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="mi">10</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reset</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">NonEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="mi">11</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="mi">12</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="mi">13</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProcessMap</span><span class="p">;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="mi">14</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">NonEmpty</span><span class="p">;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="mi">15</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="mi">16</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="mi">17</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="mi">18</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TBaseMessage</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="mi">19</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="mi">20</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="mi">21</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">message</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">TBaseMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="mi">22</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="k">operator</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="mi">23</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="mi">24</span><span class="w">         </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="mi">25</span><span class="w">         </span><span class="o">*</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="mi">26</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="mi">27</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="n">T</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="mi">28</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="mi">29</span><span class="w">         </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="mi">30</span><span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="mi">31</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="mi">32</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TCritSect</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">Msg</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="mi">33</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="mi">34</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="mi">35</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Msg</span><span class="p">;</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="mi">36</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 9. OS::message  </p>
</figcaption>
</figure>
<h3 id="interface_2">Interface<a class="headerlink" href="#interface_2" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="send"><u>send</u><a class="headerlink" href="#send" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_11">Prototype<a class="headerlink" href="#prototype_11" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">send</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_11">Description<a class="headerlink" href="#description_11" title="Permanent link">ðŸ”—</a></h6>
<p>Send the message<sup id="fnref:19"><a class="footnote-ref" href="#fn:19">19</a></sup>: the operation marks all processes waiting for the message as ready to run and invokes the scheduler.</p>
<hr />
<h4 id="send-from-isr"><u>send from ISR</u><a class="headerlink" href="#send-from-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_12">Prototype<a class="headerlink" href="#prototype_12" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">send_isr</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_12">Description<a class="headerlink" href="#description_12" title="Permanent link">ðŸ”—</a></h6>
<p>A version of the above function optimized for use in interrupt handlers. The function is inline and uses a special lightweight inline scheduler version. <em>This variant must not be used outside interrupt handler code</em>.</p>
<hr />
<h4 id="wait_1"><u>wait</u><a class="headerlink" href="#wait_1" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_13">Prototype<a class="headerlink" href="#prototype_13" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">OS::TBaseMessage::wait</span><span class="p">(</span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_13">Description<a class="headerlink" href="#description_13" title="Permanent link">ðŸ”—</a></h6>
<p>Wait for a message<sup id="fnref:20"><a class="footnote-ref" href="#fn:20">20</a></sup>: the function checks whether the message is non-empty. If it is, the function returns <code>true</code>. If it is empty, the current process is removed from the ready-to-run state and placed into a waiting state for this message.</p>
<p>If called without an argument (or with an argument of 0), waiting continues indefinitely until another process sends a message or the current process is forcibly awakened using <code>TBaseProcess::force_wake_up()</code><sup id="fnref:21"><a class="footnote-ref" href="#fn:21">21</a></sup>.</p>
<p>If a positive integer timeout (in system timer ticks) is provided, waiting occurs with a timeoutâ€”the process will be awakened in any case. If awakened before the timeout expires (i.e., a message arrives), the function returns <code>true</code>. If the timeout expires first, it returns <code>false</code>.</p>
<hr />
<h4 id="check-if-non-empty"><u>check if non-empty</u><a class="headerlink" href="#check-if-non-empty" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_14">Prototype<a class="headerlink" href="#prototype_14" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">TBaseMessage</span><span class="o">::</span><span class="n">is_non_empty</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_14">Description<a class="headerlink" href="#description_14" title="Permanent link">ðŸ”—</a></h6>
<p>Returns <code>true</code> if a message has been sent (non-empty), <code>false</code> otherwise.</p>
<hr />
<h4 id="reset"><u>reset</u><a class="headerlink" href="#reset" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_15">Prototype<a class="headerlink" href="#prototype_15" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">INLINE</span><span class="w"> </span><span class="nf">OS::TBaseMessage::reset</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_15">Description<a class="headerlink" href="#description_15" title="Permanent link">ðŸ”—</a></h6>
<p>Resets the message to the empty state. The message payload remains unchanged.</p>
<hr />
<h4 id="write-message-contents"><u>write message contents</u><a class="headerlink" href="#write-message-contents" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_16">Prototype<a class="headerlink" href="#prototype_16" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_16">Description<a class="headerlink" href="#description_16" title="Permanent link">ðŸ”—</a></h6>
<p>Writes the message payload into the message object. The standard way to use <code>OS::message</code> is to write the payload and then send the message using <code>TBaseMessage::send()</code>â€”see "Listing 10. Using OS::message".</p>
<hr />
<h4 id="access-message-body-by-reference"><u>access message body by reference</u><a class="headerlink" href="#access-message-body-by-reference" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_17">Prototype<a class="headerlink" href="#prototype_17" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="k">operator</span><span class="w"> </span><span class="n">T</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span></code></pre></div>
<h6 id="description_17">Description<a class="headerlink" href="#description_17" title="Permanent link">ðŸ”—</a></h6>
<p>Returns a constant reference to the message payload. Use this cautiouslyâ€”while accessing the payload via reference, it may be modified by another process (or interrupt handler). For safe reading, prefer the <code>message::out()</code> function.</p>
<hr />
<h4 id="read-message-contents"><u>read message contents</u><a class="headerlink" href="#read-message-contents" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_18">Prototype<a class="headerlink" href="#prototype_18" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">INLINE</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">out</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_18">Description<a class="headerlink" href="#description_18" title="Permanent link">ðŸ”—</a></h6>
<p>Designed for reading the message payload. To avoid unnecessary copying, a reference to an external payload object is passed; the function copies the message contents into it.</p>
<hr />
<h3 id="usage-example_2">Usage Example<a class="headerlink" href="#usage-example_2" title="Permanent link">ðŸ”—</a></h3>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">TMamont</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// data type for sending by message</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="mo">02</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="mo">03</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">message</span><span class="o">&lt;</span><span class="n">Mamont</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mamont_msg</span><span class="p">;</span><span class="w"> </span><span class="c1">// OS::message object</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="mo">04</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="mo">05</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="mo">06</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="mo">07</span><span class="w">     </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="mi">08</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="mi">09</span><span class="w">         </span><span class="n">Mamont</span><span class="w"> </span><span class="n">mamont</span><span class="p">;</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="mi">10</span><span class="w">         </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span><span class="w"> </span><span class="c1">// wait for message</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="mi">11</span><span class="w">         </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">out</span><span class="p">(</span><span class="n">mamont</span><span class="p">);</span><span class="w"> </span><span class="c1">// read message contents to the external object</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="mi">12</span><span class="w">         </span><span class="p">...</span><span class="w"> </span><span class="c1">// using the Mamont contents</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="mi">13</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="mi">14</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="mi">15</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="mi">16</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="mi">17</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="mi">18</span><span class="w">     </span><span class="k">for</span><span class="p">(;;)</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="mi">19</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="mi">20</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="mi">21</span><span class="w">         </span><span class="n">Mamont</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="c1">// create message content</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="mi">22</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="mi">23</span><span class="w">         </span><span class="n">m</span><span class="p">...</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// message body filling</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="mi">24</span><span class="w">         </span><span class="n">mamont_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="c1">// put the content to the OS::message object</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="mi">25</span><span class="w">         </span><span class="n">mamont_msg</span><span class="p">.</span><span class="n">send</span><span class="p">();</span><span class="w"> </span><span class="c1">// send the message</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="mi">26</span><span class="w">         </span><span class="p">...</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="mi">27</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="mi">28</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<figcaption>
<p>Listing 10. Using OS::message  </p>
</figcaption>
</figure>
<hr />
<h2 id="oschannel">OS::channel<a class="headerlink" href="#oschannel" title="Permanent link">ðŸ”—</a></h2>
<p><code>OS::channel</code> is a C++ template for creating objects that implement <strong>ring buffers</strong><sup id="fnref:22"><a class="footnote-ref" href="#fn:22">22</a></sup> for safe, preemption-aware data transfer of arbitrary types in a preemptive RTOS. Like any other interprocess communication service, <code>OS::channel</code> also handles synchronization.</p>
<p>The specific buffer type is defined at template instantiation<sup id="fnref:23"><a class="footnote-ref" href="#fn:23">23</a></sup> in user code. The <code>OS::channel</code> template is built upon a generic ring buffer template provided in the <strong>scmRTOS</strong> distribution library:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">usr</span><span class="o">::</span><span class="n">ring_buffer</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span>
</span></code></pre></div>
<p>Building channels from C++ templates provides an efficient way to create message queues of arbitrary types. Compared to the unsafe, opaque, and inflexible approach of using <code>void*</code> pointers for message queues, <code>OS::channel</code> offers:</p>
<ul>
<li><strong>Type safety</strong> through static type checkingâ€”both when creating the channel and when writing/reading data;</li>
<li><strong>Ease of use</strong>â€”no manual type casts are required, eliminating the need to keep track of actual data types for correct usage;</li>
<li><strong>Greater flexibility</strong>â€”queue elements can be any type, not just pointers.</li>
</ul>
<p>Regarding the last point: the drawback of <code>void*</code>-based message passing is that the user must allocate memory for the messages themselves. This adds extra work and results in distributed objectsâ€”the queue in one place, the message payloads elsewhere.</p>
<p>The main advantages of pointer-based messages are high efficiency with large payloads and the ability to transfer heterogeneous messages. However, when messages are small (a few bytes) and uniformly formatted, pointers are unnecessary. It is far simpler to create a queue holding the required number of such messages directly. As noted, no separate memory allocation is needed for payloadsâ€”the compiler automatically allocates storage for the entire message within the channel upon creation.</p>
<p>The channel template definition is shown in "Listing 11. Definition of the OS::channel Template".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="mo">01</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="mo">02</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">channel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TService</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="mo">03</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="mo">04</span><span class="w"> </span><span class="k">public</span><span class="o">:</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="mo">05</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">channel</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ProducersProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="mo">06</span><span class="w">                      </span><span class="p">,</span><span class="w"> </span><span class="n">ConsumersProcessMap</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="mo">07</span><span class="w">                      </span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">()</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="mi">08</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="mi">09</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="mi">10</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="mi">11</span><span class="w">     </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="mi">12</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="mi">13</span><span class="w">     </span><span class="c1">// Data transfer functions</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="mi">14</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="mi">15</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">cnt</span><span class="p">);</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="mi">16</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="mi">17</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="mi">18</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="mi">19</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">push_front</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="mi">20</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="mi">21</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">pop</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="mi">22</span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="n">pop_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="mi">23</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="mi">24</span><span class="w">     </span><span class="c1">//----------------------------------------------------------------</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="mi">25</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="mi">26</span><span class="w">     </span><span class="c1">// Service functions</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="mi">27</span><span class="w">     </span><span class="c1">//</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="mi">28</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">get_count</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="mi">29</span><span class="w">     </span><span class="n">INLINE</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">get_free_size</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="mi">30</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="n">flush</span><span class="p">();</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="mi">31</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="mi">32</span><span class="w"> </span><span class="k">private</span><span class="o">:</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="mi">33</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ProducersProcessMap</span><span class="p">;</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a><span class="mi">34</span><span class="w">     </span><span class="k">volatile</span><span class="w"> </span><span class="n">TProcessMap</span><span class="w"> </span><span class="n">ConsumersProcessMap</span><span class="p">;</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="mi">35</span><span class="w">     </span><span class="n">usr</span><span class="o">::</span><span class="n">ring_buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pool</span><span class="p">;</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="mi">36</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<figcaption>
<p>Listing 11. Definition of the OS::channel Template  </p>
</figcaption>
</figure>
<p><code>OS::channel</code> is used as follows: first define the type of objects to be transferred, then either define the channel type or create a channel object. For example, suppose the data to be transferred is a structure:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Data</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="p">{</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="p">};</span>
</span></code></pre></div>
<p>A channel object can now be created by instantiating the <code>OS::channel</code> template:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_queue</span><span class="p">;</span>
</span></code></pre></div>
<p>This declares a channel object <code>data_queue</code> for transferring <code>Data</code> objects, with a capacity of 8 items. The channel is now ready for data transfer.</p>
<p><code>OS::channel</code> supports writing data not only to the tail but also to the head of the queue, and reading not only from the head but also from the tail. Reading operations allow specifying a timeout.</p>
<p>The following interface is provided for channel operations:</p>
<h3 id="interface_3">Interface<a class="headerlink" href="#interface_3" title="Permanent link">ðŸ”—</a></h3>
<hr />
<h4 id="push"><u>push</u><a class="headerlink" href="#push" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_19">Prototype<a class="headerlink" href="#prototype_19" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">push</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_19">Description<a class="headerlink" href="#description_19" title="Permanent link">ðŸ”—</a></h6>
<p>Writes a single element to the tail of the queue<sup id="fnref:24"><a class="footnote-ref" href="#fn:24">24</a></sup>. If space is available, the element is written and the scheduler is invoked. If no space is available, the process waits until space appears, then writes the element and invokes the scheduler.</p>
<hr />
<h4 id="push_front"><u>push_front</u><a class="headerlink" href="#push_front" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_20">Prototype<a class="headerlink" href="#prototype_20" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">push_front</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_20">Description<a class="headerlink" href="#description_20" title="Permanent link">ðŸ”—</a></h6>
<p>Writes an element to the head of the queue; otherwise identical to <code>channel::push()</code>.</p>
<hr />
<h4 id="pop"><u>pop</u><a class="headerlink" href="#pop" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_21">Prototype<a class="headerlink" href="#prototype_21" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_21">Description<a class="headerlink" href="#description_21" title="Permanent link">ðŸ”—</a></h6>
<p>Extracts a single element from the head of the queue if the channel is not empty. If empty, the process waits until data arrives or the timeout expires (if specified)<sup id="fnref:25"><a class="footnote-ref" href="#fn:25">25</a></sup>.</p>
<p>When called with a timeout, returns <code>true</code> if data arrived before expiration, <code>false</code> otherwise. When called without timeout, always returns <code>true</code> (except when awakened by <code>OS::TBaseProcess::wake_up()</code> or <code>OS::TBaseProcess::force_wake_up()</code>).</p>
<p>In all cases, extracting an element invokes the scheduler.</p>
<p>Note that extracted data is returned via reference parameter rather than function return value, as the return value is used for timeout status.</p>
<hr />
<h4 id="pop_back"><u>pop_back</u><a class="headerlink" href="#pop_back" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_22">Prototype<a class="headerlink" href="#prototype_22" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">pop_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_22">Description<a class="headerlink" href="#description_22" title="Permanent link">ðŸ”—</a></h6>
<p>Extracts a single element from the tail of the queue; otherwise identical to <code>channel::pop()</code>.</p>
<hr />
<h4 id="write"><u>write</u><a class="headerlink" href="#write" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_23">Prototype<a class="headerlink" href="#prototype_23" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_23">Description<a class="headerlink" href="#description_23" title="Permanent link">ðŸ”—</a></h6>
<p>Writes multiple elements to the tail from a memory buffer. Equivalent to repeated <code>push()</code>, but waits (if necessary) until sufficient space is available for the entire block.</p>
<hr />
<h4 id="write-inside-isr"><u>write inside ISR</u><a class="headerlink" href="#write-inside-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_24">Prototype<a class="headerlink" href="#prototype_24" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">write_isr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_24">Description<a class="headerlink" href="#description_24" title="Permanent link">ðŸ”—</a></h6>
<p>Special version for use inside interrupt handlers. Writes as many elements as free space allows (up to the requested count) and returns the number written. Waiting consumers are marked ready.</p>
<p>Non-blocking. Scheduler is not invoked.</p>
<hr />
<h4 id="read"><u>read</u><a class="headerlink" href="#read" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_25">Prototype<a class="headerlink" href="#prototype_25" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kt">bool</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">read</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">timeout_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_25">Description<a class="headerlink" href="#description_25" title="Permanent link">ðŸ”—</a></h6>
<p>Extracts multiple elements from the channel. Equivalent to repeated <code>pop()</code>, but waits (if necessary) until the requested number of elements is available or timeout expires.</p>
<hr />
<h4 id="read-inside-isr"><u>read inside ISR</u><a class="headerlink" href="#read-inside-isr" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_26">Prototype<a class="headerlink" href="#prototype_26" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">read_isr</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="n">max_size</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="description_26">Description<a class="headerlink" href="#description_26" title="Permanent link">ðŸ”—</a></h6>
<p>Special version for interrupt handlers. Reads as many elements as available (up to the requested maximum) and returns the number read. Waiting producers are marked ready.</p>
<p>Non-blocking. Scheduler is not invoked.</p>
<hr />
<h4 id="get-item-count"><u>get item count</u><a class="headerlink" href="#get-item-count" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_27">Prototype<a class="headerlink" href="#prototype_27" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">get_count</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_27">Description<a class="headerlink" href="#description_27" title="Permanent link">ðŸ”—</a></h6>
<p>Returns the current number of elements in the channel. Inline for maximum efficiency.</p>
<hr />
<h4 id="get-free-size"><u>get free size</u><a class="headerlink" href="#get-free-size" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_28">Prototype<a class="headerlink" href="#prototype_28" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">get_free_size</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_28">Description<a class="headerlink" href="#description_28" title="Permanent link">ðŸ”—</a></h6>
<p>Returns the amount of free space in the channel.</p>
<hr />
<h4 id="flush"><u>flush</u><a class="headerlink" href="#flush" title="Permanent link">ðŸ”—</a></h4>
<h6 id="prototype_29">Prototype<a class="headerlink" href="#prototype_29" title="Permanent link">ðŸ”—</a></h6>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">S</span><span class="o">&gt;</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">S</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">&gt;::</span><span class="n">flush</span><span class="p">();</span>
</span></code></pre></div>
<h6 id="description_29">Description<a class="headerlink" href="#description_29" title="Permanent link">ðŸ”—</a></h6>
<p>Clears the channel by calling <code>usr::ring_buffer&lt;&gt;::flush()</code> and invokes the scheduler.</p>
<hr />
<h3 id="usage-example_3">Usage Example<a class="headerlink" href="#usage-example_3" title="Permanent link">ðŸ”—</a></h3>
<p>A simple example is shown in "Listing 12. Example of Using a Queue Based on a Channel".</p>
<figure>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="mo">01</span><span class="w"> </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="mo">02</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Cmd</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="mo">03</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="mo">04</span><span class="w">     </span><span class="k">enum</span><span class="w"> </span><span class="nc">CmdName</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cmdSetCoeff1</span><span class="p">,</span><span class="w"> </span><span class="n">cmdSetCoeff2</span><span class="p">,</span><span class="w"> </span><span class="n">cmdCheck</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">CmdName</span><span class="p">;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="mo">05</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">Value</span><span class="p">;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="mo">06</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="mo">07</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="mi">08</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">channel</span><span class="o">&lt;</span><span class="n">Cmd</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cmd_q</span><span class="p">;</span><span class="w"> </span><span class="c1">// Queue for Commands with 10 items depth</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="mi">09</span><span class="w"> </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="mi">10</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc1</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="mi">11</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="mi">12</span><span class="w">     </span><span class="p">...</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="mi">13</span><span class="w">     </span><span class="n">Cmd</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cmdSetCoeff2</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="mi">14</span><span class="w">     </span><span class="n">cmd_q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="mi">15</span><span class="w">     </span><span class="p">...</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="mi">16</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="mi">17</span><span class="w"> </span><span class="c1">//---------------------------------------------------------------------</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="mi">18</span><span class="w"> </span><span class="k">template</span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Proc2</span><span class="o">::</span><span class="n">exec</span><span class="p">()</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="mi">19</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="mi">20</span><span class="w">     </span><span class="p">...</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="mi">21</span><span class="w">     </span><span class="n">Cmd</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="mi">22</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">cmd_q</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">// wait for data, timeout 10 system ticks</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="mi">23</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="mi">24</span><span class="w">         </span><span class="p">...</span><span class="w"> </span><span class="c1">// data incoming, do something</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="mi">25</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="mi">26</span><span class="w">     </span><span class="k">else</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="mi">27</span><span class="w">     </span><span class="p">{</span>
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="mi">28</span><span class="w">         </span><span class="p">...</span><span class="w"> </span><span class="c1">// timeout expires, do something else</span>
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="mi">29</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="mi">30</span><span class="w">     </span><span class="p">...</span>
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a><span class="mi">31</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="mi">32</span><span class="w"> </span><span class="c1">//---------------------------------------------------------------------</span>
</span></code></pre></div>
<figcaption>
<p>Listing 12. Example of Using a Queue Based on a Channel  </p>
</figcaption>
</figure>
<p>As shown, usage is straightforward and clear. In one process (<code>Proc1</code>), a command message <code>cmd</code> is created (line 13), initialized, and written to the channel queue (line 14). In the other process (<code>Proc2</code>), data is awaited from the queue (line 22); upon arrival, corresponding code executes (lines 23â€“25), while timeout triggers alternative code (lines 27â€“29).</p>
<hr />
<h2 id="concluding-remarks">Concluding Remarks<a class="headerlink" href="#concluding-remarks" title="Permanent link">ðŸ”—</a></h2>
<p>There is a certain invariance among the various interprocess communication services. In other words, one service (or, more commonly, a combination of them) can accomplish the same task as another. For example, instead of using a channel, a static array could be created and data exchanged through it, employing mutual-exclusion semaphores to prevent concurrent access and event flags to notify a waiting process that data is ready. In some cases, such an implementation may prove more efficient, albeit less convenient.</p>
<p>Messages can be used for event synchronization instead of event flagsâ€”this approach makes sense when additional information needs to be transferred along with the flag. In fact, <code>OS::message</code> is specifically designed for this purpose. The variety of possible uses is vast, and the best choice for a given situation depends primarily on the specifics of that situation.</p>
<div class="admonition info">
<p class="admonition-title"><strong>TIP</strong></p>
<p>It is important to understand and remember that any interprocess communication service performs its operations within a critical section (i.e., with interrupts disabled). Therefore, these services should not be overused where they can be avoided.</p>
<p>For example, when accessing a static variable of a built-in type, using a mutual-exclusion semaphore is not a good idea compared to simply employing a critical section. A semaphore itself uses critical sections during locking and unlocking, and the time spent in them is longer than that required for direct variable access.</p>
</div>
<p>When using services in interrupt handlers, certain peculiarities arise. For instance, it is clearly a poor idea to call <code>TMutex::lock()</code> inside an interrupt handler: first, mutual-exclusion semaphores are intended for resource sharing at the process level, not the interrupt level; second, waiting for a resource to be released inside an ISR is impossible anyway and would only result in the interrupted process being placed into a waiting state at an inappropriate and unpredictable point. Effectively, the process would enter an inactive state from which it could only be extracted using <code>TBaseProcess::force_wake_up()</code>. In any case, nothing good would come of it.</p>
<p>A somewhat similar situation can occur when using channel objects in an interrupt handler. Waiting for data from a channel inside an ISR is impossible, with consequences analogous to those described above. Writing data to a channel is also not entirely safeâ€”if insufficient space is available during a write, program behavior will deviate significantly from user expectations.</p>
<div class="admonition warning">
<p class="admonition-title"><strong>RECOMMENDATION</strong></p>
<p>For operations inside interrupt handlers, use service member functions with the <code>_isr</code> suffixâ€”these are specially designed versions that ensure both efficiency and safety when employing interprocess communication services within interrupts.</p>
</div>
<p>And, of course, if the existing set of interprocess communication services does not meet the needs of a particular project for any reason, it is always possible to design a custom service class tailored to specific requirements, building upon the provided base class <code>TService</code>. The standard set of services can serve as practical examples for such design.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Since interprocess communication services perform similar operations when interacting with kernel resources, they contained nearly identical code in several places.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Or that can be developed by the user to meet the needs of their project.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>A process tag is technically a mask of type <code>TProcessMap</code> with only one non-zero bit. The position of this bit in the mask corresponds to the process priority. Process tags are used to manipulate <code>TProcessMap</code> objects, which represent process readiness/unreadiness for execution, as well as to record process tags.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Alongside the process priority number, the tag can also serve as a process identifierâ€”there is a one-to-one correspondence between a process priority and its tag. Each identifier type has efficiency advantages in specific situations, so both are extensively used in the OS code.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>In other words, "awakened" in the system timer handler.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>I.e., processes whose waiting state was not interrupted by timeout and/or forcibly via <code>TBaseProcess::wake_up()</code> or <code>TBaseProcess::force_wake_up()</code>.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>Therefore, a full description is not provided.&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p>Or an interrupt handlerâ€”depending on the event source. A special version of the signaling function exists for interrupt handlers, but in the current context this detail is immaterial and therefore omitted.&#160;<a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:9">
<p>The rest of its interface is auxiliary, serving to complete the class and improve its usability.&#160;<a class="footnote-backref" href="#fnref:9" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:10">
<p>I.e., yield control to the kernel and remain in passive waiting.&#160;<a class="footnote-backref" href="#fnref:10" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:11">
<p>Including cases where the events do not occur within the specified time interval.&#160;<a class="footnote-backref" href="#fnref:11" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:12">
<p>To make it accessible to different parts of the program.&#160;<a class="footnote-backref" href="#fnref:12" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
<li id="fn:13">
<p>General rule: every process working with a shared resource must adhere to this protocol.&#160;<a class="footnote-backref" href="#fnref:13" title="Jump back to footnote 13 in the text">&#8617;</a></p>
</li>
<li id="fn:14">
<p>A function that uses objects with non-local storage duration during its execution; calling it while another instance is already running would corrupt program integrity.&#160;<a class="footnote-backref" href="#fnref:14" title="Jump back to footnote 14 in the text">&#8617;</a></p>
</li>
<li id="fn:15">
<p>Occasionally translated as "deadly embrace".&#160;<a class="footnote-backref" href="#fnref:15" title="Jump back to footnote 15 in the text">&#8617;</a></p>
</li>
<li id="fn:16">
<p>Although nothing prevents placing the mutex outside a process's visibility and accessing it via pointer/reference, either directly or through wrapper classes that automate unlocking via their destructor.&#160;<a class="footnote-backref" href="#fnref:16" title="Jump back to footnote 16 in the text">&#8617;</a></p>
</li>
<li id="fn:17">
<p>Priorities are inversely related to their numeric valueâ€”priority 0 is highest; higher numbers mean lower priority.&#160;<a class="footnote-backref" href="#fnref:17" title="Jump back to footnote 17 in the text">&#8617;</a></p>
</li>
<li id="fn:18">
<p>The same technique is used in the process implementation: the pair <code>class TBaseProcess</code> â€“ <code>template process&lt;&gt;</code>.&#160;<a class="footnote-backref" href="#fnref:18" title="Jump back to footnote 18 in the text">&#8617;</a></p>
</li>
<li id="fn:19">
<p>Analogous to <code>OS::TEventFlag::signal()</code>.&#160;<a class="footnote-backref" href="#fnref:19" title="Jump back to footnote 19 in the text">&#8617;</a></p>
</li>
<li id="fn:20">
<p>Analogous to <code>OS::TEventFlag::wait()</code>.&#160;<a class="footnote-backref" href="#fnref:20" title="Jump back to footnote 20 in the text">&#8617;</a></p>
</li>
<li id="fn:21">
<p>The latter should be used with extreme caution.&#160;<a class="footnote-backref" href="#fnref:21" title="Jump back to footnote 21 in the text">&#8617;</a></p>
</li>
<li id="fn:22">
<p>Functionally, this is a FIFO (First In â€“ First Out) queue for data transfer.&#160;<a class="footnote-backref" href="#fnref:22" title="Jump back to footnote 22 in the text">&#8617;</a></p>
</li>
<li id="fn:23">
<p>Instantiation of the template class.&#160;<a class="footnote-backref" href="#fnref:23" title="Jump back to footnote 23 in the text">&#8617;</a></p>
</li>
<li id="fn:24">
<p>Referring to the channel queue. Since the channel is a FIFO, the tail corresponds to the FIFO input, the head to the FIFO output.&#160;<a class="footnote-backref" href="#fnref:24" title="Jump back to footnote 24 in the text">&#8617;</a></p>
</li>
<li id="fn:25">
<p>I.e., the call included a second argument specifying the timeout in system timer ticks.&#160;<a class="footnote-backref" href="#fnref:25" title="Jump back to footnote 25 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../processes/" class="btn btn-neutral float-left" title="Processes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../ports/" class="btn btn-neutral float-right" title="Ports">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../processes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../ports/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/mathjax.js"></script>
      <script src="../../js/mathjax/tex-mml-chtml.js"></script>
      <script src="../../js/wavedrom.min.js"></script>
      <script src="../../js/wavedrom_loader.js"></script>
      <script src="../../js/wavedrom.unpkg.js"></script>
      <script src="../../js/wavedrom_skin_default.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
