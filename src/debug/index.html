<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Debug - scmRTOS</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Debug";
        var mkdocs_page_input_path = "src/debug.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> scmRTOS
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Intro</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Instead of a preface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RTOS Components</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../kernel/">Kernel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../processes/">Processes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ipcs/">Interprocess Communications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ports/">Ports</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Debug</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#inspecting-process-stack-consumption">Inspecting Process Stack Consumption</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#handling-stuck-processes">Handling Stuck Processes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#process-profiling">Process Profiling</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#statistical-method">Statistical Method</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#measurement-based-method">Measurement-based Method</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#process-names">Process Names</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiler/">Process Performance Profiling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">scmRTOS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Appendix</li>
      <li class="breadcrumb-item active">Debug</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">üîó</a></h1>
<h2 id="inspecting-process-stack-consumption">Inspecting Process Stack Consumption<a class="headerlink" href="#inspecting-process-stack-consumption" title="Permanent link">üîó</a></h2>
<p>There is a question that is often quite difficult to answer definitively: what volume of RAM allocated for the stack is necessary to meet all the program's needs and ensure its correct and safe operation?</p>
<p>In the case of programs running without an OS, where all code executes using a single stack, there are tools for estimating the memory volume allocated to the stack that is necessary for correct operation. They are based on building a function call tree and known information about how much stack each function consumes. The compiler itself can perform this work, placing the results in the listing file after compiling the source file.</p>
<p>To get the final result, one must add the stack requirements of the most consuming interrupt handler to the result of the most consuming function itself.</p>
<p>Unfortunately, the described method only gives an approximate estimate, because the compiler cannot accurately build the call tree of functions that arise in practice ‚Äî in particular, indirect function calls, which include calls via pointer or virtual function calls, cannot be accounted for, as nothing is known at compile time about which specific function will be called. In specific cases where the programmer knows which functions can be called indirectly, stack consumption calculation can be done manually. But this method is inconvenient ‚Äî it must be done with every significant program change, and it is error-prone.</p>
<p>In general, the compiler is not obligated to provide such information, and third-party tools performing this work also cannot overcome the difficulties described above, which is why they have not gained popularity.</p>
<p>All this presents the program developer with a choice: what stack size to specify. On one hand, there is a desire to save RAM; on the other, it is necessary to specify a sufficient size to avoid program runtime errors, especially since errors arising from incorrect memory handling are typically very difficult to catch, as their manifestation is always individual and poorly predictable. Therefore, in practice, one has to specify the stack size with some margin, which allows for accounting for errors in underestimating its size.</p>
<p>When using an operating system, the situation is exacerbated because there is not one stack in the program, but their number equals the number of processes specified during OS configuration. This creates a greater RAM deficit and forces the developer to economize even more on memory and specify stack sizes with a smaller margin.</p>
<p>To solve the problems described above, a method of practical measurement of stack consumption by processes can be applied. This capability, like other system debugging capabilities, is enabled in <strong>scmRTOS</strong> during configuration by setting the macro <code>scmRTOS_DEBUG_ENABLE</code> to 1.</p>
<p>The essence of the method is to fill the stack space with some predetermined known value (pattern) during the stack frame preparation stage. Then, when checking the result, scan the memory area allocated for the process stack, starting from the end opposite the stack top (TOS), and find the location where the pattern filling ends. The number of cells where the pattern was not overwritten during program execution shows the actual stack size margin for the process.</p>
<p>Filling the stack with the pattern is performed in the platform-dependent function <code>init_stack_frame()</code> when debug mode is enabled. Information about the stack margin of a process can be obtained at any time by calling the function ``` for the process object, which returns an integer indicating the desired value. Based on this, the program developer can adjust stack sizes and thereby eliminate errors arising from stack overflow.</p>
<h2 id="handling-stuck-processes">Handling Stuck Processes<a class="headerlink" href="#handling-stuck-processes" title="Permanent link">üîó</a></h2>
<p>During development, a characteristic situation often arises where the program works incorrectly for unclear reasons, and by indirect signs it's easy to determine that a particular process is not working. This usually happens if a process is waiting for some service, and to find the cause of the hang, it's necessary to determine which specific service caused the wait.</p>
<p>To identify the service a process is waiting for, <strong>scmRTOS</strong> includes special debugging tools ‚Äî in particular, when a process transitions to a waiting state, the address of the service whose call triggered the transition to waiting is stored. If necessary, the user can call the process's <code>waiting_for()</code> function, which returns a pointer to the service. Knowing this address, one can always determine the service object's name using the linker map file.</p>
<h2 id="process-profiling">Process Profiling<a class="headerlink" href="#process-profiling" title="Permanent link">üîó</a></h2>
<p>Sometimes it is very useful to know the distribution of the processing load among program processes. This information allows assessing the correctness of the program's algorithms and identifying a number of elusive logical errors. Several methods exist for obtaining information about process load by determining the relative time of their active work; this is called process profiling.</p>
<p>In <strong>scmRTOS</strong>, profiling is implemented as an extension and is not part of the core OS. The profiler is an extension class that implements basic functions for collecting information about relative execution time and processing it. Collecting this information can be implemented in two ways, each with its own advantages and disadvantages:</p>
<ul>
<li>Statistical;</li>
<li>Measurement-based.</li>
</ul>
<h3 id="statistical-method">Statistical Method<a class="headerlink" href="#statistical-method" title="Permanent link">üîó</a></h3>
<p>The statistical method does not require any additional resources for its operation, except those provided by the operating system. Its working principle is based on periodically sampling the kernel variable <code>CurProcPriority</code>, which indicates which process is active at a given moment. Sampling can be conveniently organized, for example, in the system timer interrupt handler ‚Äî the more CPU time a process occupies, the more often it will be active during sampling. The disadvantage of this method is its low accuracy, allowing only a qualitative picture of what is happening.</p>
<h3 id="measurement-based-method">Measurement-based Method<a class="headerlink" href="#measurement-based-method" title="Permanent link">üîó</a></h3>
<p>This method is free from the main drawback of statistical profiling ‚Äî low accuracy in determining process load time. The principle of the measurement-based method is based on measuring the execution time of processes (hence the name). For this, the user must provide means for measuring execution time ‚Äî this could be one of the MCU's hardware timers or some other means ‚Äî for example, a processor cycle counter, if available. This is the price for using this method.</p>
<h3 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">üîó</a></h3>
<p>To use the profiler in a user project, it is necessary to define a time measurement function and connect the profiler to the project. For more details, see the <a href="../profiler/">example in the Process Profiling appendix</a>.</p>
<h2 id="process-names">Process Names<a class="headerlink" href="#process-names" title="Permanent link">üîó</a></h2>
<p>To increase debugging convenience, the ability to assign string names to processes is provided. The name is assigned in the usual way for C++ ‚Äî through a constructor argument:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">MainProc</span><span class="w"> </span><span class="nf">main_proc</span><span class="p">(</span><span class="err">‚Äú</span><span class="n">Main</span><span class="w"> </span><span class="n">Process</span><span class="err">‚Äù</span><span class="p">);</span>
</span></code></pre></div>
<p>This string argument can always be described, but the utilization of the name is available only in the debug configuration.</p>
<p>For access from a user program, the class <code>TBaseProcess</code> defines the function:
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">name</span><span class="p">();</span>
</span></code></pre></div></p>
<figure>
<p>Usage is trivial and no different from working with C-strings in C/C++. An example of debug information output can be seen in "Listing 1. Example of Debug Information Output".
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="mo">01</span><span class="w">    </span><span class="c1">//-------------------------------------------------------------------------</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="mo">02</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">ProcProfiler</span><span class="o">::</span><span class="n">get_results</span><span class="p">()</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="mo">03</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="mo">04</span><span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="s">&quot;------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="mo">05</span><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">uint_fast8_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">OS</span><span class="o">::</span><span class="n">PROCESS_COUNT</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="mo">06</span><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="mo">07</span><span class="w">        </span><span class="err">#</span><span class="k">if</span><span class="w"> </span><span class="n">scmRTOS_DEBUG_ENABLE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="mi">08</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;#%d | CPU %5.2f | Slack %d | %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="mi">09</span><span class="w">                   </span><span class="n">Profiler</span><span class="p">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="mi">10</span><span class="w">                   </span><span class="n">OS</span><span class="o">::</span><span class="n">get_proc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stack_slack</span><span class="p">(),</span><span class="w"> </span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="mi">11</span><span class="w">                   </span><span class="n">OS</span><span class="o">::</span><span class="n">get_proc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="mi">12</span><span class="w">        </span><span class="err">#</span><span class="n">endif</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="mi">13</span><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="mi">14</span><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="mi">15</span><span class="w">    </span><span class="c1">//-------------------------------------------------------------------------</span>
</span></code></pre></div></p>
<figcaption>
<p>Listing 1. Example of Debug Information Output</p>
</figcaption>
</figure>
<p>The provided code generates the following output:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>------------------------------
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>#0 | CPU 82.52 | Slack 164 | Idle
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>#1 | CPU  0.00 | Slack 178 | Background
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>#2 | CPU  0.07 | Slack 387 | GUI
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>#3 | CPU  0.23 | Slack 259 | Video
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>#4 | CPU  0.00 | Slack 148 | BiasReg
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>#5 | CPU 17.09 | Slack 165 | RefFrame
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>#6 | CPU  0.03 | Slack 204 | TempMon
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>#7 | CPU  0.00 | Slack 151 | Terminal
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>#8 | CPU  0.01 | Slack 129 | Test
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>#9 | CPU  0.01 | Slack 301 | IBoard
</span></code></pre></div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ports/" class="btn btn-neutral float-left" title="Ports"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../profiler/" class="btn btn-neutral float-right" title="Process Performance Profiling">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ports/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../profiler/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/mathjax.js"></script>
      <script src="../../js/mathjax/tex-mml-chtml.js"></script>
      <script src="../../js/wavedrom.min.js"></script>
      <script src="../../js/wavedrom_loader.js"></script>
      <script src="../../js/wavedrom.unpkg.js"></script>
      <script src="../../js/wavedrom_skin_default.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
