<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Ports - scmRTOS</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Ports";
        var mkdocs_page_input_path = "src/ports.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
 <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> scmRTOS
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Intro</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Not a Preface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">RTOS Components</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../kernel/">Kernel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../processes/">Processes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ipcs/">Interprocess Communications</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Ports</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-notes">General Notes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#porting-objects">Porting Objects</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#macros">Macros</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#types">Types</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#functions">Functions</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#porting-guidelines">Porting Guidelines</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#integration-into-a-working-project">Integration into a Working Project</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../debug/">Debug</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../profiler/">Process Profiling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../example-job-queue/">Example: Job Queue</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">scmRTOS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">RTOS Components</li>
      <li class="breadcrumb-item active">Ports</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="ports">Ports<a class="headerlink" href="#ports" title="Permanent link">ðŸ”—</a></h1>
<h2 id="general-notes">General Notes<a class="headerlink" href="#general-notes" title="Permanent link">ðŸ”—</a></h2>
<p>Due to significant differences in both hardware architectures and the development tools targeting them, adaptation of the OS code<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> to specific platforms is required. The result of this effort is the platform-specific portion, which, together with the common core, constitutes the complete port for a given platform. The process of preparing the platform-specific portion is referred to as porting.</p>
<p>This chapter primarily examines the platform-specific components, their contents and characteristics, and provides brief instructions for porting the OS&nbsp;â€“ i.e., the steps required to create a new port.</p>
<p>The platform-specific code for each target platform is contained in a separate directory and minimally includes three files:</p>
<ul>
<li><code>os_target.h</code> â€“ platform-specific declarations and macros.</li>
<li><code>os_target_asm.ext</code><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> â€“ low-level code, including context switch functions and OS startup routines.</li>
<li><code>os_target.cpp</code> â€“ definitions of the process stack frame initialization function and the interrupt handler for the timer used as the system timer.</li>
</ul>
<p>Configuration of the OS code for a target platform is achieved through:</p>
<ul>
<li>Definition of special preprocessor macros.</li>
<li>Conditional compilation directives.</li>
<li>Definition of user-defined types whose implementation depends on the target platform.</li>
<li>Type aliases for certain types.</li>
<li>Definition of functions whose implementation is delegated to the port level.</li>
</ul>
<p>A critical and delicate part of the port code involves the implementation of assembly-language subroutines responsible for system startup, saving the context of the interrupted process, switching stack pointers, and restoring the context of the process gaining control, including the software interrupt handler that performs context switching. Implementing this code requires the port developer to have in-depth knowledge of the target hardware architecture at a low level, as well as proficiency in using the toolchain (compiler, assembler, linker) for mixed-language<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> projects.</p>
<p>The porting process primarily consists of identifying the required porting objects and implementing the platform-specific code.</p>
<h2 id="porting-objects">Porting Objects<a class="headerlink" href="#porting-objects" title="Permanent link">ðŸ”—</a></h2>
<h3 id="macros">Macros<a class="headerlink" href="#macros" title="Permanent link">ðŸ”—</a></h3>
<p>A number of platform-specific macros must be defined. If a macro is not required for a particular port, it should be defined as empty. The list of macros and their descriptions is provided below.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">INLINE</span>
</span></code></pre></div>
<p>Specifies the inlining behavior for functions. Typically consists of a platform-specific unconditional inlining directive combined with the <code>inline</code> keyword.</p>
<hr />
<p>OS_PROCESS</p>
<p>Qualifies the executable function of a process. Contains a platform-specific attribute that informs the compiler that the function does not return, allowing preserved<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup> registers to be used without saving them. This reduces code size and stack usage.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">OS_INTERRUPT</span>
</span></code></pre></div>
<p>Contains a platform-specific extension used to qualify interrupt handlers on the target platform.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">DUMMY_INSTR</span><span class="p">()</span>
</span></code></pre></div>
<p>A macro defining a no-operation instruction for the target processor (typically <code>NOP</code>). Used in the context-switch waiting loop of the scheduler (in the software-interrupt-based context switch variant).</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">INLINE_PROCESS_CTOR</span>
</span></code></pre></div>
<p>Controls inlining of process constructors. If inlining is desired, this macro should be defined as <code>INLINE</code>; otherwise, it should be left empty.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">SYS_TIMER_CRIT_SECT</span><span class="p">()</span>
</span></code></pre></div>
<p>Used in the system timer interrupt handler to determine whether a critical section is required. This is relevant when the target processor has a prioritized multi-level interrupt controller, where the system timer handler could be unpredictably interrupted by a higher-priority handler accessing the same OS resources.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">CONTEXT_SWITCH_HOOK_CRIT_SECT</span>
</span></code></pre></div>
<p>Determines whether the context switch hook executes within a critical section. It is essential that the hook executes atomically with respect to kernel variable manipulation (particularly <code>SchedProcPriority</code>), meaning the scheduler must not be invoked during hook execution. Scheduler invocation can occur from interrupts if the processor has a hardware prioritized interrupt controller and the software context-switch interrupt has lower priority than others.</p>
<p>In such cases, the hook code must run in a critical section, and the macro should be defined as <code>TCritSect cs</code>. This is a critical consideration: failure to address it properly can lead to elusive runtime errors, requiring careful attention during porting.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">SEPARATE_RETURN_STACK</span>
</span></code></pre></div>
<p>For platforms with a separate return stack, this macro should be defined as 1. For all other platforms, it should be 0.</p>
<hr />
<h3 id="types">Types<a class="headerlink" href="#types" title="Permanent link">ðŸ”—</a></h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">stack_item_t</span>
</span></code></pre></div>
<p>Type alias for the built-in type representing a stack item on the target processor.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">status_reg_t</span>
</span></code></pre></div>
<p>Type alias for the built-in type matching the bit width of the target processor's status register.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">TCritSect</span>
</span></code></pre></div>
<p>Wrapper class for implementing critical sections.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">TPrioMaskTable</span>
</span></code></pre></div>
<p>Class containing a priority mask (tag) table. Used to improve system efficiency. May be omitted on platforms with hardware support for priority tag computation (e.g., a hardware shifter).</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">TISRW</span>
</span></code></pre></div>
<p>Wrapper class for interrupt handlers that utilize OS services.</p>
<h3 id="functions">Functions<a class="headerlink" href="#functions" title="Permanent link">ðŸ”—</a></h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">get_prio_tag</span><span class="p">()</span>
</span></code></pre></div>
<p>Converts a priority number to its corresponding tag. Functionally equivalent to shifting a 1 left by the priority value.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">highest_priority</span><span class="p">()</span>
</span></code></pre></div>
<p>Returns the priority number corresponding to the highest-priority process tag in the process map passed as an argument.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">disable_context_switch</span><span class="p">()</span>
</span></code></pre></div>
<p>Disables context switching. Currently implemented by disabling interrupts.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">enable_context_switch</span><span class="p">()</span>
</span></code></pre></div>
<p>Enables context switching. Currently implemented by enabling interrupts.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">os_start</span><span class="p">()</span>
</span></code></pre></div>
<p>Starts the operating system. Implemented in assembly. Receives a pointer to the stack of the highest-priority process and transfers control by restoring its context.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">os_context_switcher</span><span class="p">()</span>
</span></code></pre></div>
<p>Assembly function that performs direct context switching between processes.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">context_switcher_isr</span><span class="p">()</span>
</span></code></pre></div>
<p>Interrupt handler for context switching. Implemented in assembly. Saves the context of the interrupted process, switches stack pointers via a call to <code>context_switch_hook()</code><sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup>, and restores the context of the activated process.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">TBaseProcess</span><span class="o">::</span><span class="n">init_stack_frame</span><span class="p">()</span>
</span></code></pre></div>
<p>Initializes the stack frame of a process, arranging memory cells such that the stack appears as if the process was interrupted and its context saved. Used by the process constructor and during process restart.</p>
<hr />
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">system_timer_isr</span><span class="p">()</span>
</span></code></pre></div>
<p>System timer interrupt handler. Calls <code>TKernel::system_timer()</code>.</p>
<h2 id="porting-guidelines">Porting Guidelines<a class="headerlink" href="#porting-guidelines" title="Permanent link">ðŸ”—</a></h2>
<p>Porting typically requires defining all the macros, types, and functions listed above for the target platform.</p>
<p>The most delicate and critical tasks involve implementing the assembly code and the stack frame initialization function. Key aspects requiring particular attention include:</p>
<ul>
<li>Determining the calling conventions used by the compiler to identify which registers (or stack areas) are used for passing arguments of various types.</li>
<li>Understanding how the processor handles saving of return addresses and status registers upon interrupt occurrence&nbsp;â€“ this is essential for correct stack frame construction on the target platform, which in turn is necessary for implementing context switch functions/handlers and stack frame initialization.</li>
<li>Verifying the name mangling scheme for exported/imported symbols in assembly. In the simplest case, C names (and <code>"extern C"</code> names in C++) are visible unchanged in assembly, but on some platforms<sup id="fnref:7"><a class="footnote-ref" href="#fn:7">6</a></sup> prefixes and/or suffixes may be added, requiring assembly functions to be named accordingly for correct linker resolution.</li>
</ul>
<p>All assembly code should be placed in the file <code>os_target_asm.ext</code> mentioned earlier. Macro and type definitions, along with inline functions, belong in <code>os_target.h</code>. The file <code>os_target.cpp</code> should declare type objects if needed (e.g., <code>OS::TPrioMaskTable OS::PrioMaskTable</code>), define <code>TBaseProcess::init_stack_frame()</code> and the system timer interrupt handler <code>system_timer_isr()</code>.</p>
<p>The above provides only general information related to OS ports. Porting involves numerous specific nuances whose detailed description is beyond the scope of this document.</p>
<div class="admonition tip">
<p class="admonition-title"><strong>TIP</strong></p>
<p>When creating a new port, it is advisable to use an existing port as a template or reference&nbsp;â€“ this significantly simplifies the process. The choice of reference port depends on the architectural and toolchain similarity between the existing port and the target platform.</p>
</div>
<h2 id="integration-into-a-working-project">Integration into a Working Project<a class="headerlink" href="#integration-into-a-working-project" title="Permanent link">ðŸ”—</a></h2>
<p>To enhance flexibility and efficiency, certain platform-specific code that depends on project-specific details and the particular microcontroller used is delegated to the project level. This typically includes selection of the hardware timer used as the system timer and, where applicable, the context-switch interrupt when the processor lacks a dedicated software interrupt.</p>
<p>For port configuration, the project must include the following files:</p>
<ul>
<li><code>scmRTOS_config.h</code>;</li>
<li><code>scmRTOS_target_cfg.h</code>;</li>
</ul>
<p>The file <code>scmRTOS_config.h</code> contains most configuration macros defining parameters such as the number of processes, context switch method, enabling of system time functions, user hook support, priority value ordering, and similar settings.</p>
<p>The file <code>scmRTOS_target_cfg.h</code> contains code for managing target processor resources selected for system functions&nbsp;â€“ primarily the system timer and context-switch interrupt.</p>
<p>The contents of both configuration files are described in detail in documents specific to individual ports.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This applies not only to the OS but also to other cross-platform software.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>The file extension for assembly source code specific to the target processor.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>That is, projects containing source files in different programming languagesâ€”in this case, C++ and the assembly language of the target hardware platform.&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Registers whose values must be saved before use and restored afterward to prevent corruption of the calling function's context when invoking another function.&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>Through the wrapper function <code>os_context_switch_hook()</code>, which has <code>"extern C"</code> linkage.&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>Notably on Blackfin.&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>C++ names undergo special mangling to support function overloading and type-safe linking, making direct assembly access difficult. Therefore, functions defined in C++-compiled files that need to be accessed from assembly must be declared with <code>"extern C"</code> linkage.&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ipcs/" class="btn btn-neutral float-left" title="Interprocess Communications"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../debug/" class="btn btn-neutral float-right" title="Debug">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ipcs/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../debug/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../js/mathjax.js"></script>
      <script src="../../js/mathjax/tex-mml-chtml.js"></script>
      <script src="../../js/wavedrom.min.js"></script>
      <script src="../../js/wavedrom_loader.js"></script>
      <script src="../../js/wavedrom.unpkg.js"></script>
      <script src="../../js/wavedrom_skin_default.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
</script></body>
</html>
